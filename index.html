<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„ÙƒØ´ÙÙŠØ© Ø§Ù„Ø­Ø³Ù†ÙŠØ© Ø§Ù„Ù…ØºØ±Ø¨ÙŠØ©</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- html2pdf.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { font-family: 'Tajawal', sans-serif; }
        .animate-fadeIn { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-bounce-slow { animation: bounce 3s infinite; }
        @keyframes bounce {
            0%, 100% { transform: translateY(-5%); }
            50% { transform: translateY(5%); }
        }
        /* ØªØ­Ø³ÙŠÙ† Ø´ÙƒÙ„ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #10b981; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #047857; }
        
        /* ÙƒÙ„Ø§Ø³Ø§Øª Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
        .print-hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <div id="app"></div>

    <!-- Logic Script -->
    <script>
        // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Supabase ---
        const supabaseUrl = 'Ø¶Ø¹_SUPABASE_URL_Ù‡Ù†Ø§';
        const supabaseKey = 'Ø¶Ø¹_ANON_KEY_Ù‡Ù†Ø§';
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø±Ø§Ø¨Ø·
        const isValidSupabaseUrl = (url) => url && url.startsWith('http');
        
        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„
        const supabaseClient = (window.supabase && isValidSupabaseUrl(supabaseUrl)) 
            ? window.supabase.createClient(supabaseUrl, supabaseKey) 
            : null;

        // --- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ© ---
        const getInitialData = () => ({
            cubs: { members: [], infoCards: [], attendance: [], projects: [], program: [] },
            scouts: { members: [], infoCards: [], attendance: [], projects: [], program: [] },
            advanced: { members: [], infoCards: [], attendance: [], projects: [], program: [] },
            rovers: { members: [], infoCards: [], attendance: [], projects: [], program: [] }
        });

        const PASSWORDS = {
            admin: "yahya2026",
            cubs: "yahya123",
            scouts: "yahya1234",
            advanced: "yahya12345",
            rovers: "yahya12"
        };

        // --- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø­Ù„ ---
        const STAGES = {
            cubs: { 
                id: 'cubs', 
                name: 'Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£Ø´Ø¨Ø§Ù„', 
                color: 'bg-yellow-500', 
                iconEmoji: 'ğŸ»',
                img: 'https://i.pinimg.com/736x/ff/cd/96/ffcd96eef41c77228319b3c236ce8753.jpg' 
            },
            scouts: { 
                id: 'scouts', 
                name: 'Ù…Ø±Ø­Ù„Ø© Ø§Ù„ÙƒØ´Ø§ÙØ©', 
                color: 'bg-green-600', 
                iconEmoji: 'âšœï¸',
                img: 'https://i.pinimg.com/736x/82/28/a9/8228a9a6babbc7823c98feab17f2956a.jpg'
            },
            advanced: { 
                id: 'advanced', 
                name: 'Ù…Ø±Ø­Ù„Ø© Ø§Ù„ÙƒØ´Ø§Ù Ø§Ù„Ù…ØªÙ‚Ø¯Ù…', 
                color: 'bg-red-700', 
                iconEmoji: 'ğŸ¦…',
                img: 'https://i.pinimg.com/736x/b9/33/20/b93320870b2e389d1ca36069bb0bae3d.jpg'
            },
            rovers: { 
                id: 'rovers', 
                name: 'Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¬ÙˆØ§Ù„Ø©', 
                color: 'bg-blue-800', 
                iconEmoji: 'ğŸš¶',
                img: 'https://i.pinimg.com/736x/e5/0a/f3/e50af31e05371b9b54120ca088b310b4.jpg'
            }
        };

        // --- Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø© ---
        let state = {
            view: 'home',
            userRole: 'guest',
            selectedStage: null,
            db: getInitialData(),
            passwordInput: '',
            errorMsg: '',
            activeTab: 'members',
            loginContext: null
        };

        // --- Toast ---
        function showToast(message, type = 'success') {
            const existingToasts = document.querySelectorAll('.toast-msg');
            existingToasts.forEach(t => t.remove());

            const toast = document.createElement('div');
            const bgClass = type === 'success' ? 'bg-emerald-700' : 'bg-red-600';
            toast.className = `toast-msg fixed bottom-4 left-4 ${bgClass} text-white px-6 py-3 rounded-lg shadow-2xl transform transition-all duration-500 translate-y-20 z-50 flex items-center gap-3 font-bold border-2 border-white/20`;
            toast.innerHTML = `<i data-lucide="${type === 'success' ? 'check-circle' : 'alert-circle'}" class="w-6 h-6"></i> <span>${message}</span>`;
            document.body.appendChild(toast);
            lucide.createIcons();

            requestAnimationFrame(() => {
                toast.classList.remove('translate-y-20');
            });

            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }

        // --- Data Management ---
        async function loadData() {
            let loadedFromCloud = false;
            if (supabaseClient) {
                try {
                    const { data, error } = await supabaseClient
                        .from('scouts_data')
                        .select('payload')
                        .eq('id', 1)
                        .single();
                        
                    if (!error && data && data.payload) {
                        state.db = data.payload;
                        loadedFromCloud = true;
                    }
                } catch (e) { console.error(e); }
            }

            if (!loadedFromCloud) {
                try {
                    const savedData = localStorage.getItem('scoutsData_v3');
                    if (savedData) {
                        state.db = JSON.parse(savedData);
                        for(let key in state.db) {
                            if(!state.db[key].infoCards) state.db[key].infoCards = [];
                        }
                    } else {
                        state.db = getInitialData();
                    }
                } catch (e) {
                    state.db = getInitialData();
                }
            }
            render();
        }

        async function saveData(silent = false) {
            try {
                localStorage.setItem('scoutsData_v3', JSON.stringify(state.db));
                let cloudSuccess = false;

                if (supabaseClient) {
                    const { error } = await supabaseClient
                        .from('scouts_data')
                        .upsert({ id: 1, payload: state.db });
                    if (!error) cloudSuccess = true;
                }

                if (!silent) {
                    if (cloudSuccess) showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø³Ø­Ø§Ø¨ÙŠØ§Ù‹ ÙˆÙ…Ø­Ù„ÙŠØ§Ù‹');
                    else showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹');
                }
            } catch (e) {
                showToast('ØªÙ†Ø¨ÙŠÙ‡: Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…ØªØµÙØ­ Ù…Ù…ØªÙ„Ø¦Ø©!', 'error');
            }
        }

        // --- Export/Import ---
        function exportDatabase() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state.db));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            const date = new Date();
            downloadAnchorNode.setAttribute("download", `Ù†Ø³Ø®Ø©_ÙƒØ´Ø§ÙØ©_${date.getFullYear()}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            showToast('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©');
        }

        function triggerImport() { document.getElementById('import-input').click(); }

        function importDatabase(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if (json.cubs && json.scouts) {
                        if(confirm('Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) {
                            state.db = json;
                            for(let key in state.db) {
                                if(!state.db[key].infoCards) state.db[key].infoCards = [];
                            }
                            saveData(true);
                            render();
                            showToast('ØªÙ…Øª Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                        }
                    } else alert("Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­.");
                } catch(err) { alert("Ù…Ù„Ù ØªØ§Ù„Ù."); }
            };
            reader.readAsText(file);
            input.value = '';
        }

        // --- PDF Generation ---
        function exportToPDF() {
            const data = state.db[state.selectedStage];
            const stageInfo = STAGES[state.selectedStage];
            
            if (!data.infoCards || data.infoCards.length === 0) {
                showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø·Ø§Ù‚Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©', 'error');
                return;
            }

            // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø§ÙˆÙŠØ© Ù…Ø¤Ù‚ØªØ© Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
            const printContainer = document.createElement('div');
            printContainer.id = 'print-container-temp';
            // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ù„ØªÙƒÙˆÙ† Ø´Ø¨ÙƒØ© Ø¨Ø­Ø¬Ù… A4 ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹
            printContainer.style.width = '210mm'; 
            printContainer.style.padding = '10mm';
            printContainer.style.backgroundColor = 'white';
            printContainer.style.display = 'grid';
            printContainer.style.gridTemplateColumns = '1fr 1fr'; // Ø¨Ø·Ø§Ù‚ØªÙŠÙ† ÙÙŠ Ø§Ù„ØµÙ
            printContainer.style.gap = '15px';
            printContainer.style.direction = 'rtl';
            
            // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ù…Ù† Tailwind Ø¥Ù„Ù‰ CSS Ø¹Ø§Ø¯ÙŠ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¸Ù‡ÙˆØ±Ù‡Ø§ ÙÙŠ PDF
            const borderColor = stageInfo.id === 'cubs' ? '#eab308' : 
                               stageInfo.id === 'scouts' ? '#16a34a' : 
                               stageInfo.id === 'advanced' ? '#b91c1c' : '#1e40af';

            // Ø¥Ù†Ø´Ø§Ø¡ HTML Ù„Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
            const cardsHTML = data.infoCards.map(c => `
                <div style="border: 2px solid ${borderColor}; border-radius: 12px; height: 55mm; overflow: hidden; position: relative; font-family: 'Tajawal', sans-serif; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); page-break-inside: avoid;">
                    <!-- Header -->
                    <div style="background-color: ${borderColor}; color: white; padding: 5px 10px; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: bold; font-size: 12px;">Ø§Ù„ÙƒØ´ÙÙŠØ© Ø§Ù„Ø­Ø³Ù†ÙŠØ© Ø§Ù„Ù…ØºØ±Ø¨ÙŠØ©</span>
                        <span style="font-size: 10px;">${stageInfo.name}</span>
                    </div>
                    
                    <!-- Content -->
                    <div style="padding: 10px; display: flex; justify-content: space-between;">
                        <div style="flex: 1; text-align: right;">
                            <div style="margin-bottom: 6px;">
                                <div style="font-size: 9px; color: #6b7280;">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„:</div>
                                <div style="font-weight: bold; font-size: 13px; color: #111827;">${c.memberName}</div>
                            </div>
                            <div style="margin-bottom: 6px;">
                                <div style="font-size: 9px; color: #6b7280;">Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ÙˆØ·Ù†ÙŠØ©:</div>
                                <div style="font-weight: bold; font-size: 11px; color: #374151;">${c.cin || '---'}</div>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <div>
                                    <div style="font-size: 9px; color: #6b7280;">Ø§Ù„Ø³Ù†:</div>
                                    <div style="font-weight: bold; font-size: 11px;">${c.age} Ø³Ù†Ø©</div>
                                </div>
                                <div>
                                    <div style="font-size: 9px; color: #6b7280;">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</div>
                                    <div style="font-weight: bold; font-size: 11px;" dir="ltr">${c.phone}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Photo Placeholder -->
                        <div style="width: 25mm; height: 32mm; border: 1px dashed #d1d5db; border-radius: 6px; display: flex; flex-direction: column; align-items: center; justify-content: center; margin-right: 10px; background-color: #f9fafb;">
                            <span style="font-size: 20px; color: #9ca3af;">ğŸ“·</span>
                            <span style="font-size: 8px; color: #9ca3af; margin-top: 2px;">Ø§Ù„ØµÙˆØ±Ø©</span>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div style="position: absolute; bottom: 5px; left: 10px; right: 10px; border-top: 1px solid #e5e7eb; padding-top: 4px; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 8px; color: #6b7280;">ÙØ±Ø¹ Ù…Ø±Ø§ÙƒØ´ Ø§Ù„Ù…Ù†Ø§Ø±Ø©</span>
                        <span style="font-size: 8px; color: #6b7280;">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù‚Ø§Ø¦Ø¯: .................</span>
                    </div>
                </div>
            `).join('');

            printContainer.innerHTML = cardsHTML;
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ù„Ù„ØµÙØ­Ø© (Ù…Ø®ÙÙŠØ©) Ù„ÙƒÙŠ ÙŠØªÙ…ÙƒÙ† html2pdf Ù…Ù† Ø±Ø¤ÙŠØªÙ‡Ø§
            document.body.appendChild(printContainer);

            const opt = {
                margin: 5,
                filename: `Ø¨Ø·Ø§Ù‚Ø§Øª_${stageInfo.name}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            const btn = document.getElementById('pdf-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...';
            btn.disabled = true;

            html2pdf().set(opt).from(printContainer).save().then(() => {
                document.body.removeChild(printContainer); // Ø­Ø°Ù Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
                btn.innerHTML = originalText;
                btn.disabled = false;
                showToast('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
            });
        }

        // --- CRUD ---
        function addItem(section, item) {
            const newItem = { ...item, id: Date.now(), createdAt: new Date().toLocaleDateString('ar-MA') };
            if (!state.db[state.selectedStage][section]) {
                state.db[state.selectedStage][section] = [];
            }
            state.db[state.selectedStage][section].push(newItem);
            saveData(false);
            render();
        }

        function deleteItem(section, id) {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ')) {
                state.db[state.selectedStage][section] = state.db[state.selectedStage][section].filter(i => i.id !== id);
                saveData(false);
                render();
                showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­', 'error');
            }
        }

        // --- Navigation ---
        function setView(v) { state.view = v; state.errorMsg = ''; state.passwordInput = ''; render(); }
        function setLoginContext(c) { state.loginContext = c; setView('login'); }
        function handleStageSelect(id) { 
            state.selectedStage = id; 
            state.userRole === 'admin' ? setView('dashboard') : setView('unit-auth'); 
        }
        function handleScoutAccess() { state.userRole = 'scout'; setView('dashboard'); }
        function updatePassword(v) { state.passwordInput = v; }
        function setActiveTab(t) { state.activeTab = t; render(); }
        
        function handleLogout() {
            state.userRole = 'guest';
            state.selectedStage = null;
            setView('home');
        }

        function handleLoginSubmit() {
            const pwd = state.passwordInput;
            let success = false;
            if (state.loginContext === 'admin' && pwd === PASSWORDS.admin) {
                state.userRole = 'admin';
                setView('units');
                success = true;
            } else if (state.loginContext === 'leader' && pwd === PASSWORDS[state.selectedStage]) {
                state.userRole = 'leader';
                setView('dashboard');
                success = true;
            }
            if (!success) {
                state.errorMsg = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!';
                render();
            }
        }

        // --- Components ---
        function Header() {
            const logoutBtn = state.view !== 'home' 
                ? `<button onclick="handleLogout()" class="flex items-center gap-1 bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-sm transition text-white">
                     <i data-lucide="log-out" class="w-4 h-4"></i> Ø®Ø±ÙˆØ¬
                   </button>` : '';
            
            return `
                <div class="w-full bg-emerald-900 text-white p-3 shadow-lg flex justify-between items-center" dir="rtl">
                    <div class="font-bold text-xl flex items-center gap-3">
                        <img src="https://i.pinimg.com/736x/66/18/be/6618be9986f6409c2de5efb034453dd4.jpg" 
                             class="w-10 h-10 rounded-lg object-cover border-2 border-white/30 shadow-md hover:scale-110 transition duration-300"
                             alt="Ø´Ø¹Ø§Ø± Ø§Ù„ÙƒØ´Ø§ÙØ©" onerror="this.style.display='none'">
                        <span class="tracking-wide">Ø§Ù„ÙƒØ´ÙÙŠØ© Ø§Ù„Ø­Ø³Ù†ÙŠØ© Ø§Ù„Ù…ØºØ±Ø¨ÙŠØ©</span>
                    </div>
                    ${logoutBtn}
                </div>
            `;
        }

        function HomeScreen() {
            return `
                <div class="relative flex flex-col items-center justify-center min-h-[85vh] p-4 animate-fadeIn overflow-hidden">
                    <div class="absolute inset-0 z-0 bg-emerald-100">
                        <img src="https://i.pinimg.com/1200x/64/a5/94/64a594dff8b10396e8df4d5c0091c408.jpg" class="w-full h-full object-cover opacity-30" alt="Ø®Ù„ÙÙŠØ© ÙƒØ´ÙÙŠØ©">
                        <div class="absolute inset-0 bg-gradient-to-b from-white/10 to-emerald-900/30 pointer-events-none"></div>
                    </div>

                    <div class="relative z-10 flex flex-col items-center w-full">
                        <div class="flex items-center justify-center gap-4 md:gap-10 mb-12"> 
                            <div class="flex flex-col items-center animate-bounce-slow">
                                <div class="w-24 h-24 md:w-32 md:h-32 bg-emerald-700 rounded-lg flex items-center justify-center shadow-xl border-4 border-green-700 overflow-hidden transform hover:scale-105 transition">
                                    <img src="https://i.pinimg.com/736x/66/18/be/6618be9986f6409c2de5efb034453dd4.jpg" class="w-full h-full object-cover opacity-100">
                                </div>
                            </div>
                            
                            <div class="flex flex-col items-center relative z-40 -mt-8 md:-mt-12"> 
                                <div class="w-35 h-35 md:w-56 md:h-56 flex items-center justify-center transform hover:scale-110 transition duration-500 filter drop-shadow-2xl border-4 border-green-700 rounded-lg overflow-hidden">
                                    <img src="https://i.pinimg.com/736x/b6/23/7f/b6237f449b7666f92c96fd59a994982c.jpg" class="w-full h-full object-cover">
                                </div>
                            </div>

                            <div class="flex flex-col items-center animate-bounce-slow">
                                <div class="w-24 h-24 md:w-32 md:h-32 bg-emerald-700 rounded-lg flex items-center justify-center shadow-xl border-4 border-green-700 overflow-hidden transform hover:scale-105 transition">
                                    <img src="https://i.pinimg.com/736x/58/56/b6/5856b6659cffb1319a107d48fca3dc21.jpg" class="w-full h-full object-cover opacity-100">
                                </div>
                            </div>
                        </div>

                        <h1 class="text-4xl md:text-6xl font-extrabold text-emerald-900 mb-2 text-center drop-shadow-sm text-white drop-shadow-lg" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">ÙØ±Ø¹ Ù…Ø±Ø§ÙƒØ´ Ø§Ù„Ù…Ù†Ø§Ø±Ø©</h1>
                        <p class="text-white mb-12 text-lg font-bold drop-shadow-md">ÙƒÙ† Ù…Ø³ØªØ¹Ø¯Ø§Ù‹ .. Ø¯Ø§Ø¦Ù…Ø§Ù‹</p>

                        <div class="flex flex-col gap-4 w-full max-w-md">
                            <button onclick="setView('units')" class="bg-emerald-600 hover:bg-emerald-700 text-white text-xl font-bold py-4 rounded-xl shadow-lg transform hover:-translate-y-1 transition duration-300 flex items-center justify-center gap-3 border border-emerald-400">
                                <i data-lucide="users"></i> Ù‚Ø§Ø¯Ø© Ø§Ù„Ù…Ø±Ø§Ø­Ù„ ÙˆØ§Ù„ÙˆØ­Ø¯Ø§Øª
                            </button>
                            
                            <button onclick="setLoginContext('admin')" class="bg-gray-800 hover:bg-gray-900 text-white text-lg font-bold py-3 rounded-xl shadow-md transform hover:-translate-y-1 transition duration-300 flex items-center justify-center gap-3 border border-gray-600">
                                <i data-lucide="shield" class="w-5 h-5"></i> Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function LoginScreen() {
            const title = state.loginContext === 'admin' ? "ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©" : `Ø¯Ø®ÙˆÙ„ Ù‚Ø§Ø¦Ø¯ ${STAGES[state.selectedStage]?.name}`;
            return `
                <div class="flex flex-col items-center justify-center min-h-[60vh] p-4 animate-fadeIn" dir="rtl">
                    <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md border-t-4 border-emerald-600">
                        <div class="flex justify-center mb-6 text-emerald-700"><i data-lucide="lock" class="w-12 h-12"></i></div>
                        <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">${title}</h2>
                        <input type="password" id="passwordInput" dir="ltr" value="${state.passwordInput}" oninput="updatePassword(this.value)" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ..." class="w-full p-3 border border-gray-300 rounded-lg mb-4 text-center text-lg focus:ring-2 focus:ring-emerald-500 outline-none placeholder:text-right" />
                        ${state.errorMsg ? `<p class="text-red-500 text-center mb-4 font-medium">${state.errorMsg}</p>` : ''}
                        <button onclick="handleLoginSubmit()" class="w-full bg-emerald-700 text-white py-3 rounded-lg font-bold hover:bg-emerald-800 transition shadow-md">Ø¯Ø®ÙˆÙ„</button>
                        <button onclick="setView('home')" class="w-full mt-3 text-gray-500 hover:text-gray-700">Ø¥Ù„ØºØ§Ø¡</button>
                    </div>
                </div>
            `;
        }

        function UnitsScreen() {
            const adminBadge = state.userRole === 'admin' ? '<span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm font-bold">ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¯ÙŠØ±</span>' : '';
            const backupControls = state.userRole === 'admin' ? `
                <div class="mb-8 p-6 bg-blue-50 border-2 border-blue-200 rounded-2xl flex flex-col md:flex-row justify-between items-center gap-6 shadow-sm">
                    <div class="flex items-start gap-3 text-blue-900">
                        <div class="bg-blue-100 p-2 rounded-lg"><i data-lucide="database" class="w-6 h-6 text-blue-600"></i></div>
                        <div>
                            <span class="font-bold text-lg block">Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø£Ù…Ø§Ù† (Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)</span>
                            <span class="text-sm text-blue-700 opacity-90">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙÙ‚Ø·: Ø­ÙØ¸ ÙˆØ§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒØ§Ù…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹</span>
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="exportDatabase()" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold transition">
                            <i data-lucide="download" class="w-4 h-4"></i> Ø­ÙØ¸ Ù†Ø³Ø®Ø©
                        </button>
                        <button onclick="triggerImport()" class="flex items-center gap-2 bg-white border border-blue-300 text-blue-700 hover:bg-blue-50 px-4 py-2 rounded-lg font-bold transition">
                            <i data-lucide="upload" class="w-4 h-4"></i> Ø§Ø³ØªØ±Ø¬Ø§Ø¹
                        </button>
                    </div>
                </div>
            ` : '';

            let cardsHtml = '';
            for (const key in STAGES) {
                const stage = STAGES[key];
                cardsHtml += `
                    <div onclick="handleStageSelect('${stage.id}')" class="bg-white rounded-2xl shadow-lg hover:shadow-2xl transition duration-300 cursor-pointer overflow-hidden transform hover:-translate-y-2 group border border-gray-100 relative">
                        <div class="h-48 w-full overflow-hidden relative bg-white">
                            <img src="${stage.img}" alt="${stage.name}" class="w-full h-full object-cover transition duration-700 group-hover:scale-110" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                            <div class="${stage.color} w-full h-full absolute top-0 left-0 hidden items-center justify-center">
                                <span class="text-6xl text-white">${stage.iconEmoji}</span>
                            </div>
                            <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent flex flex-col justify-end p-4 pointer-events-none">
                                <div class="absolute top-4 right-4 bg-white p-1 rounded-full shadow-lg border-2 border-emerald-500">
                                    <img src="${stage.img}" class="w-10 h-10 rounded-full object-cover" onerror="this.src='https://via.placeholder.com/40'">
                                </div>
                            </div>
                        </div>
                        <div class="p-5 text-center relative z-10">
                            <h3 class="text-xl font-bold text-gray-800 mb-2 group-hover:text-emerald-600 transition">${stage.name}</h3>
                            <div class="flex items-center justify-center gap-1 text-emerald-600 text-sm font-medium opacity-80 group-hover:opacity-100">
                                <span>Ø§Ø¶ØºØ· Ù„Ù„Ø¯Ø®ÙˆÙ„</span>
                                <i data-lucide="arrow-left" class="w-4 h-4"></i>
                            </div>
                        </div>
                    </div>
                `;
            }
            return `
                <div class="max-w-6xl mx-auto p-6 animate-fadeIn min-h-[80vh]">
                    <div class="flex justify-between items-center mb-8">
                        <h2 class="text-3xl font-bold text-gray-800 border-r-4 border-emerald-500 pr-4">Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø§Ù„ÙƒØ´ÙÙŠØ©</h2>
                        ${adminBadge}
                    </div>
                    ${backupControls}
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                        ${cardsHtml}
                    </div>
                    <div class="mt-12 text-center">
                        <button onclick="setView('home')" class="text-gray-500 hover:text-emerald-700 font-medium flex items-center justify-center gap-2 mx-auto">
                            <i data-lucide="home" class="w-4 h-4"></i>
                            Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                        </button>
                    </div>
                </div>
            `;
        }

        function UnitAuthScreen() {
            return `
                <div class="flex flex-col items-center justify-center min-h-[60vh] p-4 animate-fadeIn" dir="rtl">
                    <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-lg text-center">
                        <div class="flex justify-center mb-6">
                            <img src="${STAGES[state.selectedStage]?.img}" class="w-24 h-24 rounded-full object-cover border-4 border-emerald-100 shadow-lg" onerror="this.style.display='none'">
                        </div>
                        <h2 class="text-2xl font-bold mb-8 text-gray-800">Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ ${STAGES[state.selectedStage]?.name}</h2>
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="setLoginContext('leader')" class="flex flex-col items-center justify-center p-6 bg-emerald-50 hover:bg-emerald-100 border-2 border-emerald-200 rounded-xl transition group">
                                <i data-lucide="user-check" class="text-emerald-700 w-10 h-10 mb-2 group-hover:scale-110 transition"></i>
                                <span class="font-bold text-emerald-900">Ø£Ù†Ø§ Ù‚Ø§Ø¦Ø¯</span>
                                <span class="text-xs text-gray-500 mt-1">ØªØ¹Ø¯ÙŠÙ„ ÙˆØ¥Ø¯Ø§Ø±Ø©</span>
                            </button>
                            <button onclick="handleScoutAccess()" class="flex flex-col items-center justify-center p-6 bg-blue-50 hover:bg-blue-100 border-2 border-blue-200 rounded-xl transition group">
                                <i data-lucide="user" class="text-blue-700 w-10 h-10 mb-2 group-hover:scale-110 transition"></i>
                                <span class="font-bold text-blue-900">Ø£Ù†Ø§ ÙƒØ´Ø§Ù</span>
                                <span class="text-xs text-gray-500 mt-1">Ø§Ø·Ù„Ø§Ø¹ ÙÙ‚Ø·</span>
                            </button>
                        </div>
                        <button onclick="setView('units')" class="mt-6 text-gray-500 flex items-center justify-center gap-1 mx-auto hover:text-gray-700">
                            <i data-lucide="chevron-left" class="w-4 h-4"></i> Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ø±Ø§Ø­Ù„
                        </button>
                    </div>
                </div>
            `;
        }

        function DashboardScreen() {
            const stage = STAGES[state.selectedStage];
            const data = state.db[state.selectedStage];
            const canEdit = state.userRole === 'admin' || state.userRole === 'leader';
            
            const backupSection = canEdit ? `
                <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-xl flex justify-between items-center flex-wrap gap-2">
                    <div class="text-blue-800 text-sm font-bold flex items-center gap-2">
                        <i data-lucide="save" class="w-4 h-4"></i>
                        <span>Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ (Ø£Ù…Ø§Ù†):</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="exportDatabase()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-lg text-sm font-bold flex items-center gap-1 transition shadow-sm">
                            <i data-lucide="download" class="w-4 h-4"></i> Ø­ÙØ¸ Ù†Ø³Ø®Ø©
                        </button>
                        <button onclick="triggerImport()" class="bg-white border border-blue-300 text-blue-700 hover:bg-blue-50 px-3 py-1.5 rounded-lg text-sm font-bold flex items-center gap-1 transition shadow-sm">
                            <i data-lucide="upload" class="w-4 h-4"></i> Ø§Ø³ØªØ±Ø¬Ø§Ø¹
                        </button>
                        <input type="file" id="import-input" class="hidden" accept=".json" onchange="importDatabase(this)" />
                    </div>
                </div>
            ` : '';

            const tabs = [
                { id: 'members', label: 'Ø§Ù„Ù…Ù†Ø®Ø±Ø·ÙˆÙ†', icon: 'users' },
                { id: 'infoCards', label: 'Ø¨Ø·Ø§Ù‚Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ±Ø¯', icon: 'contact' },
                { id: 'attendance', label: 'Ù„Ø§Ø¦Ø­Ø© Ø§Ù„Ø­Ø¶ÙˆØ±', icon: 'check-square' },
                { id: 'projects', label: 'Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹', icon: 'compass' },
                { id: 'program', label: 'Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬', icon: 'calendar' }
            ];

            let tabsHtml = tabs.map(tab => `
                <button onclick="setActiveTab('${tab.id}')" 
                    class="flex-1 flex items-center justify-center gap-2 py-4 px-6 font-medium transition whitespace-nowrap ${state.activeTab === tab.id ? 'text-emerald-700 border-b-4 border-emerald-600 bg-emerald-50' : 'text-gray-500 hover:text-emerald-600 hover:bg-gray-50'}">
                    <i data-lucide="${tab.icon}" class="w-5 h-5"></i>
                    ${tab.label}
                </button>
            `).join('');

            let contentHtml = '';
            const renderTable = (headers, rows) => `
                <div class="overflow-x-auto">
                    <table class="w-full text-right border-collapse">
                        <thead><tr class="bg-gray-100 text-gray-700">${headers.map(h => `<th class="p-3">${h}</th>`).join('')}${canEdit ? '<th class="p-3 w-20">Ø¥Ø¬Ø±Ø§Ø¡</th>' : ''}</tr></thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>`;

            if (state.activeTab === 'members') {
                const rows = (data.members || []).map((m, idx) => `
                    <tr class="border-b border-gray-50 hover:bg-gray-50">
                        <td class="p-3 font-medium">${m.name}</td>
                        <td class="p-3 text-gray-600">${m.age ? m.age + ' Ø³Ù†Ø©' : '-'}</td>
                        <td class="p-3 text-gray-500">#${idx + 1}</td>
                        <td class="p-3 text-emerald-600 font-bold">${m.fee} Ø¯Ø±Ù‡Ù…</td>
                        ${canEdit ? `<td class="p-3 text-center"><button onclick="deleteItem('members', ${m.id})" class="text-red-500 hover:bg-red-50 p-2 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>` : ''}
                    </tr>`).join('');
                
                contentHtml = canEdit ? `
                    <form onsubmit="event.preventDefault(); const fd=new FormData(this); addItem('members', {name: fd.get('name'), age: fd.get('age'), fee: fd.get('fee')}); this.reset();" class="bg-gray-50 p-4 rounded-lg mb-6 border border-gray-200 shadow-sm grid gap-3 md:grid-cols-5 items-end">
                        <input name="name" required placeholder="Ø§Ù„Ø¥Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" class="p-2 border rounded md:col-span-2">
                        <input name="age" required type="number" placeholder="Ø§Ù„Ø³Ù†" class="p-2 border rounded">
                        <input name="fee" required type="number" placeholder="Ø«Ù…Ù† Ø§Ù„Ø§Ù†Ø®Ø±Ø§Ø·" class="p-2 border rounded">
                        <button type="submit" class="bg-emerald-600 text-white p-2 rounded hover:bg-emerald-700 flex items-center justify-center gap-1 font-bold"><i data-lucide="plus" class="w-4 h-4"></i> Ø¥Ø¶Ø§ÙØ©</button>
                    </form>` : '';
                contentHtml += rows ? renderTable(['Ø§Ù„Ø¥Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„', 'Ø§Ù„Ø³Ù†', 'Ø±Ù‚Ù… Ø§Ù„Ø§Ù†Ø®Ø±Ø§Ø·', 'Ø«Ù…Ù† Ø§Ù„Ø§Ù†Ø®Ø±Ø§Ø·'], rows) : '<p class="text-center p-8 text-gray-400">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>';
            
            } else if (state.activeTab === 'infoCards') {
                const cards = (data.infoCards || []).map(c => `
                    <div class="bg-white border border-gray-200 rounded-xl p-5 shadow-sm hover:shadow-md transition relative group">
                        <div class="flex items-center gap-3 mb-3 border-b border-gray-100 pb-2">
                            <div class="bg-emerald-100 p-2 rounded-full text-emerald-700"><i data-lucide="user" class="w-5 h-5"></i></div>
                            <h3 class="font-bold text-lg text-gray-800">${c.memberName}</h3>
                        </div>
                        <div class="space-y-2 text-sm text-gray-600">
                            <p class="flex justify-between items-center"><span>Ø§Ù„Ø³Ù†:</span> <span class="font-bold text-gray-800">${c.age} Ø³Ù†Ø©</span></p>
                            <p class="flex justify-between items-center"><span>ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±:</span> <span class="font-bold text-gray-800">${c.parentName}</span></p>
                            <p class="flex justify-between items-center"><span>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</span> <span class="font-bold text-gray-800" dir="ltr">${c.phone}</span></p>
                            <p class="flex justify-between items-center"><span>Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© (CIN):</span> <span class="font-bold text-gray-800 uppercase">${c.cin}</span></p>
                        </div>
                        ${canEdit ? `<button onclick="deleteItem('infoCards', ${c.id})" class="absolute top-3 left-3 text-red-400 hover:text-red-600 transition opacity-0 group-hover:opacity-100"><i data-lucide="trash-2" class="w-5 h-5"></i></button>` : ''}
                    </div>
                `).join('');

                const pdfBtn = (data.infoCards && data.infoCards.length > 0) ? `
                    <div class="mb-4 flex justify-end">
                        <button id="pdf-btn" onclick="exportToPDF()" class="bg-red-600 hover:bg-red-700 text-white px-5 py-2.5 rounded-lg font-bold flex items-center gap-2 shadow-md transition transform hover:-translate-y-0.5">
                            <i data-lucide="printer" class="w-5 h-5"></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª (PDF)
                        </button>
                    </div>
                ` : '';

                contentHtml = pdfBtn;

                if (canEdit) {
                    contentHtml += `
                    <form onsubmit="event.preventDefault(); const fd=new FormData(this); addItem('infoCards', {
                        memberName: fd.get('memberName'),
                        parentName: fd.get('parentName'),
                        cin: fd.get('cin'),
                        age: fd.get('age'),
                        phone: fd.get('phone')
                    }); this.reset();" class="bg-gray-50 p-4 rounded-lg mb-6 border border-gray-200 shadow-sm">
                        <h4 class="font-bold text-gray-700 mb-4 border-b pb-2">Ø¥Ø¶Ø§ÙØ© Ø¨Ø·Ø§Ù‚Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</h4>
                        <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3 items-end">
                            <input name="memberName" required placeholder="Ø¥Ø³Ù… Ø§Ù„Ù…Ù†Ø®Ø±Ø·" class="p-2 border rounded w-full">
                            <input name="age" type="number" required placeholder="Ø§Ù„Ø³Ù†" class="p-2 border rounded w-full">
                            <input name="parentName" required placeholder="Ø¥Ø³Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±" class="p-2 border rounded w-full">
                            <input name="cin" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ÙˆØ·Ù†ÙŠØ© (CIN)" class="p-2 border rounded w-full uppercase">
                            <input name="phone" required placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" class="p-2 border rounded w-full">
                            <button type="submit" class="bg-emerald-600 text-white p-2 rounded hover:bg-emerald-700 flex items-center justify-center gap-1 font-bold w-full"><i data-lucide="plus" class="w-4 h-4"></i> Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</button>
                        </div>
                    </form>
                    `;
                }
                
                contentHtml += `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${cards}</div>`;
                if (!cards && !canEdit) contentHtml += '<p class="text-center p-8 text-gray-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø·Ø§Ù‚Ø§Øª Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</p>';

            } else if (state.activeTab === 'attendance') {
                const rows = (data.attendance || []).map(a => `
                     <tr class="border-b border-gray-50 hover:bg-gray-50">
                        <td class="p-3 font-medium">${a.name}</td>
                        <td class="p-3"><span class="px-3 py-1 rounded-full text-sm ${a.status === 'Ø­Ø§Ø¶Ø±' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">${a.status}</span></td>
                        ${canEdit ? `<td class="p-3 text-center"><button onclick="deleteItem('attendance', ${a.id})" class="text-red-500 hover:bg-red-50 p-2 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>` : ''}
                     </tr>`).join('');
                
                contentHtml = canEdit ? `
                     <form onsubmit="event.preventDefault(); const fd=new FormData(this); addItem('attendance', {name: fd.get('name'), status: fd.get('status')}); this.reset();" class="bg-gray-50 p-4 rounded-lg mb-6 border border-gray-200 shadow-sm grid gap-3 md:grid-cols-4 items-end">
                        <input name="name" required placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" class="p-2 border rounded md:col-span-2">
                        <select name="status" class="p-2 border rounded"><option value="Ø­Ø§Ø¶Ø±">Ø­Ø§Ø¶Ø±</option><option value="ØºØ§Ø¦Ø¨">ØºØ§Ø¦Ø¨</option></select>
                        <button type="submit" class="bg-emerald-600 text-white p-2 rounded hover:bg-emerald-700 flex items-center justify-center gap-1 font-bold"><i data-lucide="plus" class="w-4 h-4"></i> Ø¥Ø¶Ø§ÙØ©</button>
                    </form>` : '';
                contentHtml += rows ? renderTable(['Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„', 'Ø§Ù„Ø­Ø§Ù„Ø©'], rows) : '<p class="text-center p-8 text-gray-400">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>';

            } else if (state.activeTab === 'projects') {
                const cards = (data.projects || []).map(p => `
                    <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition bg-gradient-to-br from-white to-gray-50 relative group">
                        <h3 class="font-bold text-lg text-emerald-800 mb-2">${p.name}</h3>
                        <p class="text-gray-600 text-sm leading-relaxed">${p.desc}</p>
                        ${canEdit ? `<button onclick="deleteItem('projects', ${p.id})" class="absolute top-2 left-2 text-red-400 opacity-0 group-hover:opacity-100 hover:text-red-600 transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : ''}
                    </div>`).join('');
                
                contentHtml = canEdit ? `
                     <form onsubmit="event.preventDefault(); const fd=new FormData(this); addItem('projects', {name: fd.get('name'), desc: fd.get('desc')}); this.reset();" class="bg-gray-50 p-4 rounded-lg mb-6 border border-gray-200 shadow-sm grid gap-3 md:grid-cols-4 items-end">
                        <input name="name" required placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹" class="p-2 border rounded md:col-span-1">
                        <input name="desc" required placeholder="Ø§Ù„ÙˆØµÙ / Ø§Ù„Ø­Ø§Ù„Ø©" class="p-2 border rounded md:col-span-2">
                        <button type="submit" class="bg-emerald-600 text-white p-2 rounded hover:bg-emerald-700 flex items-center justify-center gap-1 font-bold"><i data-lucide="plus" class="w-4 h-4"></i> Ø¥Ø¶Ø§ÙØ©</button>
                    </form>` : '';
                contentHtml += `<div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">${cards}</div>`;

            } else if (state.activeTab === 'program') {
                const items = (data.program || []).map(prog => `
                    <div class="flex flex-col md:flex-row md:items-center bg-white border border-gray-100 p-4 rounded-lg shadow-sm hover:shadow-md transition">
                        <div class="flex items-center gap-3 md:w-1/4 mb-2 md:mb-0">
                            <div class="bg-emerald-100 text-emerald-700 p-2 rounded-lg"><i data-lucide="calendar" class="w-5 h-5"></i></div>
                            <span class="font-bold text-gray-700">${prog.date}</span>
                        </div>
                        <div class="md:w-2/4 mb-2 md:mb-0"><h4 class="font-bold text-lg text-gray-800">${prog.activity}</h4></div>
                        <div class="md:w-1/4 text-sm text-gray-500 flex justify-between items-center">
                            <span>${prog.notes}</span>
                            ${canEdit ? `<button onclick="deleteItem('program', ${prog.id})" class="text-red-400 hover:text-red-600 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : ''}
                        </div>
                    </div>`).join('');
                
                contentHtml = canEdit ? `
                     <form onsubmit="event.preventDefault(); const fd=new FormData(this); addItem('program', {activity: fd.get('activity'), date: fd.get('date'), notes: fd.get('notes')}); this.reset();" class="bg-gray-50 p-4 rounded-lg mb-6 border border-gray-200 shadow-sm grid gap-3 md:grid-cols-4 items-end">
                        <input name="name" required placeholder="Ø§Ù„Ù†Ø´Ø§Ø·" class="p-2 border rounded">
                        <input name="date" required type="date" class="p-2 border rounded">
                        <input name="notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª" class="p-2 border rounded">
                        <button type="submit" class="bg-emerald-600 text-white p-2 rounded hover:bg-emerald-700 flex items-center justify-center gap-1 font-bold"><i data-lucide="plus" class="w-4 h-4"></i> Ø¥Ø¶Ø§ÙØ©</button>
                    </form>` : '';
                contentHtml += `<div class="space-y-3">${items}</div>`;
            }

            return `
                <div class="max-w-6xl mx-auto p-4 animate-fadeIn" dir="rtl">
                    <div class="relative rounded-t-2xl overflow-hidden shadow-md text-white h-48">
                        <img src="${stage.img}" class="absolute w-full h-full object-cover">
                        <div class="absolute inset-0 bg-gradient-to-r from-black/80 to-transparent p-6 flex justify-between items-center">
                            <div class="relative z-10">
                                <h1 class="text-3xl font-bold flex items-center gap-3">
                                    <img src="${stage.img}" class="w-16 h-16 rounded-full border-4 border-white/30 shadow-sm object-cover bg-white" onerror="this.src='https://via.placeholder.com/64'">
                                    ${stage.name}
                                </h1>
                                <p class="opacity-90 mt-1 mr-20 text-sm font-medium text-emerald-100">${state.userRole === 'admin' ? 'ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…' : state.userRole === 'leader' ? 'ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù‚Ø§Ø¦Ø¯' : 'ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©'}</p>
                            </div>
                            <button onclick="setView('units')" class="bg-white/20 hover:bg-white/30 p-2 rounded-full transition backdrop-blur-sm relative z-10"><i data-lucide="chevron-left" class="w-6 h-6"></i></button>
                        </div>
                    </div>
                    ${backupSection}
                    <div class="flex overflow-x-auto bg-white shadow border-b border-gray-200">
                        ${tabsHtml}
                    </div>
                    <div class="bg-white p-6 rounded-b-2xl shadow min-h-[400px]">
                        ${contentHtml}
                    </div>
                </div>
            `;
        }

        function render() {
            const app = document.getElementById('app');
            let html = Header();
            if (state.view === 'home') html += HomeScreen();
            else if (state.view === 'login') html += LoginScreen();
            else if (state.view === 'units') html += UnitsScreen();
            else if (state.view === 'unit-auth') html += UnitAuthScreen();
            else if (state.view === 'dashboard') html += DashboardScreen();
            app.innerHTML = html;
            if (window.lucide) lucide.createIcons();
            if (state.view === 'login') {
                const input = document.getElementById('passwordInput');
                if(input) {
                    input.focus();
                    input.value = state.passwordInput;
                }
            }
        }

        window.onload = function() {
            loadData();
        };
    </script>
</body>
</html>
