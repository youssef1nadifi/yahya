<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„ÙƒØ´Ø§ÙØ© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Tajawal', sans-serif; }
        .animate-fadeIn { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-bounce-slow { animation: bounce 3s infinite; }
        @keyframes bounce {
            0%, 100% { transform: translateY(-5%); }
            50% { transform: translateY(5%); }
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #10b981; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #047857; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #10b981;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <div id="app">
        <div class="h-screen flex flex-col items-center justify-center gap-4">
            <div class="loader"></div>
            <p id="loading-text" class="text-gray-600 font-bold">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
        </div>
    </div>

    <!-- Firebase Configuration & Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // Fixed import: Ensure signInWithCustomToken is imported
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ---
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… try-catch Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ø­ØªÙ…Ø§Ù„ ØºÙŠØ§Ø¨ Ø§Ù„ØªÙƒÙˆÙŠÙ†
        let firebaseConfig, app, auth, db, appId;
        
        try {
            firebaseConfig = JSON.parse(__firebase_config);
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';
        } catch (e) {
            console.error("Firebase Config Error:", e);
            document.getElementById('loading-text').innerText = "Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.";
            document.getElementById('loading-text').classList.add('text-red-500');
        }
        
        let currentUser = null;

        // --- Ø§Ù„Ø«ÙˆØ§Ø¨Øª ---
        const PASSWORDS = {
            admin: "yahya2026",
            cubs: "yahya123",
            scouts: "yahya1234",
            advanced: "yahya12345",
            rovers: "yahya12"
        };

        const STAGES = {
            cubs: { id: 'cubs', name: 'Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£Ø´Ø¨Ø§Ù„', color: 'bg-yellow-500', iconEmoji: 'ğŸ»' },
            scouts: { id: 'scouts', name: 'Ù…Ø±Ø­Ù„Ø© Ø§Ù„ÙƒØ´Ø§ÙØ©', color: 'bg-green-600', iconEmoji: 'âšœï¸' },
            advanced: { id: 'advanced', name: 'Ù…Ø±Ø­Ù„Ø© Ø§Ù„ÙƒØ´Ø§Ù Ø§Ù„Ù…ØªÙ‚Ø¯Ù…', color: 'bg-red-700', iconEmoji: 'ğŸ¦…' },
            rovers: { id: 'rovers', name: 'Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¬ÙˆØ§Ù„Ø©', color: 'bg-blue-800', iconEmoji: 'ğŸš¶' }
        };

        const INITIAL_DATA = {
            cubs: { members: [], attendance: [], projects: [], program: [] },
            scouts: { members: [], attendance: [], projects: [], program: [] },
            advanced: { members: [], attendance: [], projects: [], program: [] },
            rovers: { members: [], attendance: [], projects: [], program: [] }
        };

        // --- Ø§Ù„Ø­Ø§Ù„Ø© (State) ---
        let state = {
            view: 'home',
            userRole: 'guest',
            selectedStage: null,
            db: INITIAL_DATA,
            passwordInput: '',
            errorMsg: '',
            activeTab: 'members',
            loginContext: null,
            isLoading: true
        };

        // --- Ø¥Ø¯Ø§Ø±Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Firestore) ---
        
        // 1. Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙˆØ§Ù„Ø§ØªØµØ§Ù„ (Ù…Ø¹ Fallback)
        async function initApp() {
            if (!auth) return; // Stop if auth failed to init
            
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth Error (Custom Token):", error);
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¬Ù‡ÙˆÙ„ ÙƒØ¨Ø¯ÙŠÙ„ ÙÙŠ Ø­Ø§Ù„ ÙØ´Ù„ Ø§Ù„ØªÙˆÙƒÙ†
                try {
                    await signInAnonymously(auth);
                } catch (anonError) {
                    console.error("Auth Critical Error:", anonError);
                    document.getElementById('loading-text').innerText = "ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.";
                    document.getElementById('loading-text').classList.add('text-red-500');
                }
            }
        }

        initApp();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                setupRealtimeListener();
            }
        });

        // 2. Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØºÙŠÙŠØ±Ø§Øª (Real-time Listener)
        function setupRealtimeListener() {
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'scouts_data', 'main_db');
            
            onSnapshot(docRef, (snapshot) => {
                state.isLoading = false;
                if (snapshot.exists()) {
                    state.db = snapshot.data();
                } else {
                    // Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©
                    setDoc(docRef, INITIAL_DATA).catch(e => console.error("Init DB Error:", e));
                    state.db = INITIAL_DATA;
                }
                render();
            }, (error) => {
                console.error("Firestore Error:", error);
                state.isLoading = false;
                render(); // Render anyway with local/initial data if offline
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¯ÙŠØ«Ø©ØŒ ÙŠØªÙ… Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¤Ù‚ØªØ©.");
            });
        }

        // 3. Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ù…Ø¨Ø§Ø´Ø±Ø©)
        window.addItem = async function(section, item) {
            if (!currentUser) return;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'scouts_data', 'main_db');
            
            // Ù†Ø£Ø®Ø° Ù†Ø³Ø®Ø© Ø¹Ù…ÙŠÙ‚Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§
            const newDb = JSON.parse(JSON.stringify(state.db));
            const stage = state.selectedStage;
            
            newDb[stage][section].push({ ...item, id: Date.now() });
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙÙˆØ±Ø§Ù‹ Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© (Optimistic UI)
            state.db = newDb;
            render();

            try {
                await updateDoc(docRef, newDb);
            } catch (e) {
                console.error("Save Error:", e);
                alert("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©: " + e.message);
            }
        };

        window.deleteItem = async function(section, id) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ')) return;
            if (!currentUser) return;
            
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'scouts_data', 'main_db');
            const newDb = JSON.parse(JSON.stringify(state.db));
            const stage = state.selectedStage;
            
            newDb[stage][section] = newDb[stage][section].filter(i => i.id !== id);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙÙˆØ±Ø§Ù‹
            state.db = newDb;
            render();

            try {
                await updateDoc(docRef, newDb);
            } catch (e) {
                console.error("Delete Error:", e);
                alert("ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©: " + e.message);
            }
        };

        // --- Ø¯ÙˆØ§Ù„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (Actions) ---
        
        window.setView = function(view) {
            state.view = view;
            state.errorMsg = '';
            state.passwordInput = '';
            render();
        };

        window.handleLogout = function() {
            state.userRole = 'guest';
            state.selectedStage = null;
            state.passwordInput = '';
            setView('home');
        };

        window.handleLoginSubmit = function() {
            const pwd = state.passwordInput;
            
            if (state.loginContext === 'admin') {
                if (pwd === PASSWORDS.admin) {
                    state.userRole = 'admin';
                    setView('units');
                } else {
                    state.errorMsg = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!';
                    render();
                }
            } else if (state.loginContext === 'leader') {
                if (pwd === PASSWORDS[state.selectedStage]) {
                    state.userRole = 'leader';
                    setView('dashboard');
                } else {
                    state.errorMsg = 'Ø±Ù…Ø² Ø§Ù„Ù‚Ø§Ø¦Ø¯ ØºÙŠØ± ØµØ­ÙŠØ­!';
                    render();
                }
            }
        };

        window.handleStageSelect = function(stageId) {
            state.selectedStage = stageId;
            if (state.userRole === 'admin') {
                setView('dashboard');
            } else {
                setView('unit-auth');
            }
        };

        window.handleScoutAccess = function() {
            state.userRole = 'scout';
            setView('dashboard');
        };

        window.setLoginContext = function(context) {
            state.loginContext = context;
            setView('login');
        };

        window.updatePassword = function(val) {
            state.passwordInput = val;
        };

        window.setActiveTab = function(tab) {
            state.activeTab = tab;
            render();
        };


        // --- Ù…ÙƒÙˆÙ†Ø§Øª ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ---

        function Header() {
            const logoutBtn = state.view !== 'home' 
                ? `<button onclick="handleLogout()" class="flex items-center gap-1 bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-sm transition text-white">
                     <i data-lucide="log-out" class="w-4 h-4"></i> Ø®Ø±ÙˆØ¬
                   </button>` 
                : '';
            
            return `
                <div class="w-full bg-emerald-900 text-white p-4 shadow-lg flex justify-between items-center" dir="rtl">
                    <div class="font-bold text-xl flex items-center gap-2">
                        <i data-lucide="tent" class="w-6 h-6"></i>
                        Ù†Ø¸Ø§Ù… Ø§Ù„ÙƒØ´Ø§ÙØ© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„
                    </div>
                    ${logoutBtn}
                </div>
            `;
        }

        function HomeScreen() {
            return `
                <div class="flex flex-col items-center justify-center min-h-[85vh] p-4 animate-fadeIn">
                    <div class="flex gap-4 md:gap-12 mb-12">
                        <div class="flex flex-col items-center animate-bounce-slow">
                            <div class="w-24 h-24 md:w-32 md:h-32 bg-emerald-700 rounded-full flex items-center justify-center shadow-xl border-4 border-yellow-400">
                                <i data-lucide="tent" class="text-white w-12 h-12 md:w-16 md:h-16"></i>
                            </div>
                        </div>
                        <div class="flex flex-col items-center -mt-8">
                            <div class="w-28 h-28 md:w-40 md:h-40 bg-white rounded-full flex items-center justify-center shadow-2xl border-4 border-emerald-600 z-10">
                                <i data-lucide="flame" class="text-orange-500 w-16 h-16 md:w-20 md:h-20"></i>
                            </div>
                        </div>
                        <div class="flex flex-col items-center animate-bounce-slow" style="animation-delay: 0.2s">
                            <div class="w-24 h-24 md:w-32 md:h-32 bg-emerald-700 rounded-full flex items-center justify-center shadow-xl border-4 border-yellow-400">
                                <i data-lucide="compass" class="text-white w-12 h-12 md:w-16 md:h-16"></i>
                            </div>
                        </div>
                    </div>

                    <h1 class="text-4xl md:text-6xl font-extrabold text-emerald-900 mb-2 text-center drop-shadow-sm">ÙƒØ´Ø§ÙØ© Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„</h1>
                    <p class="text-gray-500 mb-12 text-lg">ÙƒÙ† Ù…Ø³ØªØ¹Ø¯Ø§Ù‹ .. Ø¯Ø§Ø¦Ù…Ø§Ù‹</p>

                    <div class="flex flex-col gap-4 w-full max-w-md">
                        <button onclick="setView('units')" class="bg-emerald-600 hover:bg-emerald-700 text-white text-xl font-bold py-4 rounded-xl shadow-lg transform hover:-translate-y-1 transition duration-300 flex items-center justify-center gap-3">
                            <i data-lucide="users"></i> Ù‚Ø§Ø¯Ø© Ø§Ù„Ù…Ø±Ø§Ø­Ù„ ÙˆØ§Ù„ÙˆØ­Ø¯Ø§Øª
                        </button>
                        
                        <button onclick="setLoginContext('admin')" class="bg-gray-800 hover:bg-gray-900 text-white text-lg font-bold py-3 rounded-xl shadow-md transform hover:-translate-y-1 transition duration-300 flex items-center justify-center gap-3">
                            <i data-lucide="shield" class="w-5 h-5"></i> Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
                        </button>
                    </div>
                </div>
            `;
        }

        function LoginScreen() {
            const title = state.loginContext === 'admin' ? "ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©" : `Ø¯Ø®ÙˆÙ„ Ù‚Ø§Ø¦Ø¯ ${STAGES[state.selectedStage]?.name}`;
            
            return `
                <div class="flex flex-col items-center justify-center min-h-[60vh] p-4 animate-fadeIn" dir="rtl">
                    <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md border-t-4 border-emerald-600">
                        <div class="flex justify-center mb-6 text-emerald-700">
                            <i data-lucide="lock" class="w-12 h-12"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">${title}</h2>
                        
                        <input
                            type="password"
                            id="passwordInput"
                            dir="ltr"
                            value="${state.passwordInput}"
                            oninput="updatePassword(this.value)"
                            placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ..."
                            class="w-full p-3 border border-gray-300 rounded-lg mb-4 text-center text-lg focus:ring-2 focus:ring-emerald-500 outline-none placeholder:text-right"
                        />
                        
                        ${state.errorMsg ? `<p class="text-red-500 text-center mb-4 font-medium">${state.errorMsg}</p>` : ''}
                        
                        <button onclick="handleLoginSubmit()" class="w-full bg-emerald-700 text-white py-3 rounded-lg font-bold hover:bg-emerald-800 transition shadow-md">
                            Ø¯Ø®ÙˆÙ„
                        </button>
                        <button onclick="setView('home')" class="w-full mt-3 text-gray-500 hover:text-gray-700">
                            Ø¥Ù„ØºØ§Ø¡
                        </button>
                    </div>
                </div>
            `;
        }

        function UnitsScreen() {
            const adminBadge = state.userRole === 'admin' ? '<span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm font-bold">ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¯ÙŠØ±</span>' : '';
            
            let cardsHtml = '';
            for (const key in STAGES) {
                const stage = STAGES[key];
                cardsHtml += `
                    <div onclick="handleStageSelect('${stage.id}')" class="bg-white rounded-2xl shadow-lg hover:shadow-2xl transition duration-300 cursor-pointer overflow-hidden transform hover:-translate-y-2 group border border-gray-100">
                        <div class="${stage.color} h-32 flex items-center justify-center">
                            <span class="text-6xl group-hover:scale-110 transition duration-300 drop-shadow-md">${stage.iconEmoji}</span>
                        </div>
                        <div class="p-6 text-center">
                            <h3 class="text-xl font-bold text-gray-800 mb-2">${stage.name}</h3>
                            <span class="text-emerald-600 text-sm font-medium">Ø§Ø¶ØºØ· Ù„Ù„Ø¯Ø®ÙˆÙ„</span>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="max-w-6xl mx-auto p-6 animate-fadeIn min-h-[80vh]">
                    <div class="flex justify-between items-center mb-8">
                        <h2 class="text-3xl font-bold text-gray-800 border-r-4 border-emerald-500 pr-4">Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø§Ù„ÙƒØ´ÙÙŠØ©</h2>
                        ${adminBadge}
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        ${cardsHtml}
                    </div>
                    <div class="mt-12 text-center">
                        <button onclick="setView('home')" class="text-gray-500 hover:text-emerald-700 font-medium">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
                    </div>
                </div>
            `;
        }

        function UnitAuthScreen() {
            return `
                <div class="flex flex-col items-center justify-center min-h-[60vh] p-4 animate-fadeIn" dir="rtl">
                    <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-lg text-center">
                        <h2 class="text-2xl font-bold mb-8 text-gray-800">
                            Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ ${STAGES[state.selectedStage]?.name}
                        </h2>
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="setLoginContext('leader')" class="flex flex-col items-center justify-center p-6 bg-emerald-50 hover:bg-emerald-100 border-2 border-emerald-200 rounded-xl transition group">
                                <i data-lucide="user-check" class="text-emerald-700 w-10 h-10 mb-2 group-hover:scale-110 transition"></i>
                                <span class="font-bold text-emerald-900">Ø£Ù†Ø§ Ù‚Ø§Ø¦Ø¯</span>
                                <span class="text-xs text-gray-500 mt-1">ØªØ¹Ø¯ÙŠÙ„ ÙˆØ¥Ø¯Ø§Ø±Ø©</span>
                            </button>

                            <button onclick="handleScoutAccess()" class="flex flex-col items-center justify-center p-6 bg-blue-50 hover:bg-blue-100 border-2 border-blue-200 rounded-xl transition group">
                                <i data-lucide="user" class="text-blue-700 w-10 h-10 mb-2 group-hover:scale-110 transition"></i>
                                <span class="font-bold text-blue-900">Ø£Ù†Ø§ ÙƒØ´Ø§Ù</span>
                                <span class="text-xs text-gray-500 mt-1">Ø§Ø·Ù„Ø§Ø¹ ÙÙ‚Ø·</span>
                            </button>
                        </div>
                        <button onclick="setView('units')" class="mt-6 text-gray-500 flex items-center justify-center gap-1 mx-auto hover:text-gray-700">
                            <i data-lucide="chevron-left" class="w-4 h-4"></i> Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ø±Ø§Ø­Ù„
                        </button>
                    </div>
                </div>
            `;
        }

        function DashboardScreen() {
            const stage = STAGES[state.selectedStage];
            const data = state.db[state.selectedStage] || INITIAL_DATA[state.selectedStage]; // Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ©
            const canEdit = state.userRole === 'admin' || state.userRole === 'leader';
            
            const tabs = [
                { id: 'members', label: 'Ø§Ù„Ù…Ù†Ø®Ø±Ø·ÙˆÙ†', icon: 'users' },
                { id: 'attendance', label: 'Ù„Ø§Ø¦Ø­Ø© Ø§Ù„Ø­Ø¶ÙˆØ±', icon: 'check-square' },
                { id: 'projects', label: 'Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹', icon: 'compass' },
                { id: 'program', label: 'Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬', icon: 'calendar' }
            ];

            let tabsHtml = tabs.map(tab => `
                <button onclick="setActiveTab('${tab.id}')" 
                    class="flex-1 flex items-center justify-center gap-2 py-4 px-6 font-medium transition whitespace-nowrap ${state.activeTab === tab.id ? 'text-emerald-700 border-b-4 border-emerald-600 bg-emerald-50' : 'text-gray-500 hover:text-emerald-600 hover:bg-gray-50'}">
                    <i data-lucide="${tab.icon}" class="w-5 h-5"></i>
                    ${tab.label}
                </button>
            `).join('');

            let contentHtml = '';
            
            if (state.activeTab === 'members') {
                const addForm = canEdit ? `
                    <form onsubmit="event.preventDefault(); const fd=new FormData(this); addItem('members', {name: fd.get('name'), fee: fd.get('fee')}); this.reset();" class="bg-gray-50 p-4 rounded-lg mb-6 border border-gray-200 shadow-sm grid gap-3 md:grid-cols-4 items-end">
                        <input name="name" required placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø®Ø±Ø·" class="p-2 border rounded">
                        <input name="fee" required type="number" placeholder="Ø«Ù…Ù† Ø§Ù„Ø§Ù†Ø®Ø±Ø§Ø·" class="p-2 border rounded">
                        <div class="hidden md:block"></div>
                        <button type="submit" class="bg-emerald-600 text-white p-2 rounded hover:bg-emerald-700 flex items-center justify-center gap-1 font-bold"><i data-lucide="plus" class="w-4 h-4"></i> Ø¥Ø¶Ø§ÙØ©</button>
                    </form>
                ` : '';

                const rows = (data.members || []).map((m, idx) => `
                    <tr class="border-b border-gray-50 hover:bg-gray-50">
                        <td class="p-3 font-medium">${m.name}</td>
                        <td class="p-3 text-gray-500">#${idx + 1}</td>
                        <td class="p-3 text-emerald-600 font-bold">${m.fee} Ø¯Ø±Ù‡Ù…</td>
                        ${canEdit ? `<td class="p-3 text-center"><button onclick="deleteItem('members', ${m.id})" class="text-red-500 hover:bg-red-50 p-2 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>` : ''}
                    </tr>
                `).join('');

                contentHtml = `
                    ${addForm}
                    <div class="overflow-x-auto">
                        <table class="w-full text-right border-collapse">
                            <thead><tr class="bg-gray-100 text-gray-700"><th class="p-3 rounded-r-lg">Ø§Ù„Ø§Ø³Ù…</th><th class="p-3">Ø±Ù‚Ù… Ø§Ù„Ø§Ù†Ø®Ø±Ø§Ø·</th><th class="p-3 rounded-l-lg">Ø«Ù…Ù† Ø§Ù„Ø§Ù†Ø®Ø±Ø§Ø·</th>${canEdit ? '<th class="p-3 w-20">Ø¥Ø¬Ø±Ø§Ø¡</th>' : ''}</tr></thead>
                            <tbody>${rows || '<tr><td colspan="4" class="text-center p-8 text-gray-400">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù†Ø®Ø±Ø·ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹</td></tr>'}</tbody>
                            <tfoot class="bg-gray-50 font-bold"><tr><td class="p-3">Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${(data.members || []).length}</td><td colspan="3"></td></tr></tfoot>
                        </table>
                    </div>
                `;
            } else if (state.activeTab === 'attendance') {
                const addForm = canEdit ? `
                     <form onsubmit="event.preventDefault(); const fd=new FormData(this); addItem('attendance', {name: fd.get('name'), status: fd.get('status')}); this.reset();" class="bg-gray-50 p-4 rounded-lg mb-6 border border-gray-200 shadow-sm grid gap-3 md:grid-cols-4 items-end">
                        <input name="name" required placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" class="p-2 border rounded md:col-span-2">
                        <select name="status" class="p-2 border rounded">
                            <option value="Ø­Ø§Ø¶Ø±">Ø­Ø§Ø¶Ø±</option>
                            <option value="ØºØ§Ø¦Ø¨">ØºØ§Ø¦Ø¨</option>
                        </select>
                        <button type="submit" class="bg-emerald-600 text-white p-2 rounded hover:bg-emerald-700 flex items-center justify-center gap-1 font-bold"><i data-lucide="plus" class="w-4 h-4"></i> Ø¥Ø¶Ø§ÙØ©</button>
                    </form>
                ` : '';

                const rows = (data.attendance || []).map(a => `
                     <tr class="border-b border-gray-50 hover:bg-gray-50">
                       <td class="p-3 font-medium">${a.name}</td>
                       <td class="p-3"><span class="px-3 py-1 rounded-full text-sm ${a.status === 'Ø­Ø§Ø¶Ø±' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">${a.status}</span></td>
                       ${canEdit ? `<td class="p-3 text-center"><button onclick="deleteItem('attendance', ${a.id})" class="text-red-500 hover:bg-red-50 p-2 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>` : ''}
                     </tr>
                `).join('');

                contentHtml = `${addForm}<div class="overflow-x-auto"><table class="w-full text-right border-collapse"><thead><tr class="bg-gray-100 text-gray-700"><th class="p-3 rounded-r-lg">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</th><th class="p-3 rounded-l-lg">Ø§Ù„Ø­Ø§Ù„Ø©</th>${canEdit ? '<th class="p-3 w-20">Ø¥Ø¬Ø±Ø§Ø¡</th>' : ''}</tr></thead><tbody>${rows}</tbody></table></div>`;
            
            } else if (state.activeTab === 'projects') {
                const addForm = canEdit ? `
                     <form onsubmit="event.preventDefault(); const fd=new FormData(this); addItem('projects', {name: fd.get('name'), desc: fd.get('desc')}); this.reset();" class="bg-gray-50 p-4 rounded-lg mb-6 border border-gray-200 shadow-sm grid gap-3 md:grid-cols-4 items-end">
                        <input name="name" required placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹" class="p-2 border rounded md:col-span-1">
                        <input name="desc" required placeholder="Ø§Ù„ÙˆØµÙ / Ø§Ù„Ø­Ø§Ù„Ø©" class="p-2 border rounded md:col-span-2">
                        <button type="submit" class="bg-emerald-600 text-white p-2 rounded hover:bg-emerald-700 flex items-center justify-center gap-1 font-bold"><i data-lucide="plus" class="w-4 h-4"></i> Ø¥Ø¶Ø§ÙØ©</button>
                    </form>
                ` : '';

                const cards = (data.projects || []).map(p => `
                    <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition bg-gradient-to-br from-white to-gray-50 relative group">
                        <h3 class="font-bold text-lg text-emerald-800 mb-2">${p.name}</h3>
                        <p class="text-gray-600 text-sm leading-relaxed">${p.desc}</p>
                        ${canEdit ? `<button onclick="deleteItem('projects', ${p.id})" class="absolute top-2 left-2 text-red-400 opacity-0 group-hover:opacity-100 hover:text-red-600 transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : ''}
                    </div>
                `).join('');
                
                contentHtml = `${addForm}<div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">${cards}</div>${(data.projects || []).length === 0 ? '<p class="text-center text-gray-400 py-8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø³Ø¬Ù„Ø©</p>' : ''}`;
            
            } else if (state.activeTab === 'program') {
                 const addForm = canEdit ? `
                     <form onsubmit="event.preventDefault(); const fd=new FormData(this); addItem('program', {activity: fd.get('activity'), date: fd.get('date'), notes: fd.get('notes')}); this.reset();" class="bg-gray-50 p-4 rounded-lg mb-6 border border-gray-200 shadow-sm grid gap-3 md:grid-cols-4 items-end">
                        <input name="activity" required placeholder="Ø§Ù„Ù†Ø´Ø§Ø·" class="p-2 border rounded">
                        <input name="date" required type="date" class="p-2 border rounded">
                        <input name="notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª" class="p-2 border rounded">
                        <button type="submit" class="bg-emerald-600 text-white p-2 rounded hover:bg-emerald-700 flex items-center justify-center gap-1 font-bold"><i data-lucide="plus" class="w-4 h-4"></i> Ø¥Ø¶Ø§ÙØ©</button>
                    </form>
                ` : '';
                
                const items = (data.program || []).map(prog => `
                    <div class="flex flex-col md:flex-row md:items-center bg-white border border-gray-100 p-4 rounded-lg shadow-sm hover:shadow-md transition">
                        <div class="flex items-center gap-3 md:w-1/4 mb-2 md:mb-0">
                            <div class="bg-emerald-100 text-emerald-700 p-2 rounded-lg"><i data-lucide="calendar" class="w-5 h-5"></i></div>
                            <span class="font-bold text-gray-700">${prog.date}</span>
                        </div>
                        <div class="md:w-2/4 mb-2 md:mb-0"><h4 class="font-bold text-lg text-gray-800">${prog.activity}</h4></div>
                        <div class="md:w-1/4 text-sm text-gray-500 flex justify-between items-center">
                            <span>${prog.notes}</span>
                            ${canEdit ? `<button onclick="deleteItem('program', ${prog.id})" class="text-red-400 hover:text-red-600 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : ''}
                        </div>
                    </div>
                `).join('');

                contentHtml = `${addForm}<div class="space-y-3">${items}</div>${(data.program || []).length === 0 ? '<p class="text-center text-gray-400 py-8">Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ÙØ§Ø±Øº Ø­Ø§Ù„ÙŠØ§Ù‹</p>' : ''}`;
            }

            return `
                <div class="max-w-6xl mx-auto p-4 animate-fadeIn" dir="rtl">
                    <div class="${stage.color} text-white p-6 rounded-t-2xl shadow-md flex justify-between items-center">
                        <div>
                            <h1 class="text-3xl font-bold flex items-center gap-3">
                                <span class="text-4xl">${stage.iconEmoji}</span>
                                ${stage.name}
                            </h1>
                            <p class="opacity-90 mt-1 mr-12 text-sm">
                                ${state.userRole === 'admin' ? 'ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…' : state.userRole === 'leader' ? 'ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù‚Ø§Ø¦Ø¯' : 'ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©'}
                            </p>
                        </div>
                        <button onclick="setView('units')" class="bg-white/20 hover:bg-white/30 p-2 rounded-full transition">
                            <i data-lucide="chevron-left" class="w-6 h-6"></i>
                        </button>
                    </div>

                    <div class="flex overflow-x-auto bg-white shadow border-b border-gray-200">
                        ${tabsHtml}
                    </div>

                    <div class="bg-white p-6 rounded-b-2xl shadow min-h-[400px]">
                        ${contentHtml}
                    </div>
                </div>
            `;
        }

        // --- Ø¯Ø§Ù„Ø© Ø§Ù„Ø¹Ø±Ø¶ (Render) ---
        window.render = function() {
            const app = document.getElementById('app');
            
            if (state.isLoading) {
                 // ØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡ ÙÙŠ Ø§Ù„Ù€ HTML Ø§Ù„Ø£ÙˆÙ„ÙŠ
                 return;
            }

            let html = Header();

            if (state.view === 'home') html += HomeScreen();
            else if (state.view === 'login') html += LoginScreen();
            else if (state.view === 'units') html += UnitsScreen();
            else if (state.view === 'unit-auth') html += UnitAuthScreen();
            else if (state.view === 'dashboard') html += DashboardScreen();

            app.innerHTML = html;
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª
            if (window.lucide) lucide.createIcons();

            // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
            if (state.view === 'login') {
                const input = document.getElementById('passwordInput');
                if(input) {
                    input.focus();
                    input.value = state.passwordInput;
                }
            }
        };

    </script>
</body>
</html>
