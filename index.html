<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„ÙƒØ´ÙÙŠØ© Ø§Ù„Ø­Ø³Ù†ÙŠØ© Ø§Ù„Ù…ØºØ±Ø¨ÙŠØ©</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Supabase CDN (ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Tajawal', sans-serif; }
        .animate-fadeIn { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-bounce-slow { animation: bounce 3s infinite; }
        @keyframes bounce {
            0%, 100% { transform: translateY(-5%); }
            50% { transform: translateY(5%); }
        }
        /* ØªØ­Ø³ÙŠÙ† Ø´ÙƒÙ„ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #10b981; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #047857; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <div id="app"></div>

    <!-- Logic Script -->
    <script>
        // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Supabase (ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©) ---
        const supabaseUrl = 'Ø¶Ø¹_SUPABASE_URL_Ù‡Ù†Ø§';
        const supabaseKey = 'Ø¶Ø¹_ANON_KEY_Ù‡Ù†Ø§';
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…ÙƒØªØ¨Ø© ÙˆØ£Ù† Ø§Ù„Ø±Ø§Ø¨Ø· ØµØ§Ù„Ø­ Ù‚Ø¨Ù„ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
        const isValidSupabaseUrl = (url) => url && url.startsWith('http');
        
        // ØªÙ… ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù…ØªØºÙŠØ± Ù…Ù† supabase Ø¥Ù„Ù‰ supabaseClient Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªØ¹Ø§Ø±Ø¶ Ù…Ø¹ Ø§Ù„Ù…ÙƒØªØ¨Ø©
        const supabaseClient = (window.supabase && isValidSupabaseUrl(supabaseUrl)) 
            ? window.supabase.createClient(supabaseUrl, supabaseKey) 
            : null;

        // --- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ© ---
        const getInitialData = () => ({
            cubs: { members: [], attendance: [], projects: [], program: [] },
            scouts: { members: [], attendance: [], projects: [], program: [] },
            advanced: { members: [], attendance: [], projects: [], program: [] },
            rovers: { members: [], attendance: [], projects: [], program: [] }
        });

        const PASSWORDS = {
            admin: "yahya2026",
            cubs: "yahya123",
            scouts: "yahya1234",
            advanced: "yahya12345",
            rovers: "yahya12"
        };

        // --- ØªØ­Ø¯ÙŠØ« Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„ØµÙˆØ± Ù„ØªÙƒÙˆÙ† Ø±ÙˆØ§Ø¨Ø· Pinterest Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© ---
        const STAGES = {
            cubs: { 
                id: 'cubs', 
                name: 'Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£Ø´Ø¨Ø§Ù„', 
                color: 'bg-yellow-500', 
                iconEmoji: 'ğŸ»',
                img: 'https://i.pinimg.com/736x/ff/cd/96/ffcd96eef41c77228319b3c236ce8753.jpg' 
            },
            scouts: { 
                id: 'scouts', 
                name: 'Ù…Ø±Ø­Ù„Ø© Ø§Ù„ÙƒØ´Ø§ÙØ©', 
                color: 'bg-green-600', 
                iconEmoji: 'âšœï¸',
                img: 'https://i.pinimg.com/736x/82/28/a9/8228a9a6babbc7823c98feab17f2956a.jpg'
            },
            advanced: { 
                id: 'advanced', 
                name: 'Ù…Ø±Ø­Ù„Ø© Ø§Ù„ÙƒØ´Ø§Ù Ø§Ù„Ù…ØªÙ‚Ø¯Ù…', 
                color: 'bg-red-700', 
                iconEmoji: 'ğŸ¦…',
                img: 'https://i.pinimg.com/736x/b9/33/20/b93320870b2e389d1ca36069bb0bae3d.jpg'
            },
            rovers: { 
                id: 'rovers', 
                name: 'Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¬ÙˆØ§Ù„Ø©', 
                color: 'bg-blue-800', 
                iconEmoji: 'ğŸš¶',
                img: 'https://i.pinimg.com/736x/e5/0a/f3/e50af31e05371b9b54120ca088b310b4.jpg'
            }
        };

        // --- Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø© ---
        let state = {
            view: 'home',
            userRole: 'guest',
            selectedStage: null,
            db: getInitialData(),
            passwordInput: '',
            errorMsg: '',
            activeTab: 'members',
            loginContext: null
        };

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (Toast) ---
        function showToast(message, type = 'success') {
            const existingToasts = document.querySelectorAll('.toast-msg');
            existingToasts.forEach(t => t.remove());

            const toast = document.createElement('div');
            const bgClass = type === 'success' ? 'bg-emerald-700' : 'bg-red-600';
            toast.className = `toast-msg fixed bottom-4 left-4 ${bgClass} text-white px-6 py-3 rounded-lg shadow-2xl transform transition-all duration-500 translate-y-20 z-50 flex items-center gap-3 font-bold border-2 border-white/20`;
            toast.innerHTML = `<i data-lucide="${type === 'success' ? 'check-circle' : 'alert-circle'}" class="w-6 h-6"></i> <span>${message}</span>`;
            document.body.appendChild(toast);
            lucide.createIcons();

            requestAnimationFrame(() => {
                toast.classList.remove('translate-y-20');
            });

            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }

        // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (LocalStorage + Supabase) ---
        async function loadData() {
            let loadedFromCloud = false;

            // 1. Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Supabase Ø£ÙˆÙ„Ø§Ù‹
            if (supabaseClient) {
                try {
                    // Ù†ÙØªØ±Ø¶ ÙˆØ¬ÙˆØ¯ Ø¬Ø¯ÙˆÙ„ 'scouts_data'
                    const { data, error } = await supabaseClient
                        .from('scouts_data')
                        .select('payload')
                        .eq('id', 1)
                        .single();
                        
                    if (!error && data && data.payload) {
                        state.db = data.payload;
                        loadedFromCloud = true;
                        console.log("Loaded from Supabase successfully");
                    }
                } catch (e) {
                    console.error("Supabase load error:", e);
                }
            }

            // 2. Ø¥Ø°Ø§ Ù„Ù… Ù†Ù†Ø¬Ø­ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØŒ Ù†Ø³ØªØ®Ø¯Ù… LocalStorage
            if (!loadedFromCloud) {
                try {
                    const savedData = localStorage.getItem('scoutsData_v3');
                    if (savedData) {
                        state.db = JSON.parse(savedData);
                    } else {
                        state.db = getInitialData();
                    }
                } catch (e) {
                    console.error("Error loading local data", e);
                    state.db = getInitialData();
                }
            }
            render();
        }

        async function saveData(silent = false) {
            try {
                // 1. Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ù„ÙŠ (LocalStorage) - ÙƒÙ†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø³Ø±ÙŠØ¹Ø©
                localStorage.setItem('scoutsData_v3', JSON.stringify(state.db));
                
                let cloudSuccess = false;

                // 2. Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ (Supabase)
                if (supabaseClient) {
                    // Ù†Ù‚ÙˆÙ… Ø¨Ø¹Ù…Ù„ Upsert (ØªØ­Ø¯ÙŠØ« Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡) Ù„Ù„ØµÙ Ø±Ù‚Ù… 1
                    const { error } = await supabaseClient
                        .from('scouts_data')
                        .upsert({ id: 1, payload: state.db });
                    
                    if (error) {
                        console.error('Supabase Save Error:', error);
                    } else {
                        cloudSuccess = true;
                    }
                }

                // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
                if (!silent) {
                    if (cloudSuccess) {
                        showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø³Ø­Ø§Ø¨ÙŠØ§Ù‹ ÙˆÙ…Ø­Ù„ÙŠØ§Ù‹ Ø¨Ù†Ø¬Ø§Ø­');
                    } else if (!supabaseClient) {
                        showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ (Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø³Ø­Ø§Ø¨ÙŠ)');
                    } else {
                        showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ (ÙØ´Ù„ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ)', 'error');
                    }
                }
            } catch (e) {
                console.error("Save failed", e);
                showToast('ØªÙ†Ø¨ÙŠÙ‡: Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…ØªØµÙØ­ Ù…Ù…ØªÙ„Ø¦Ø©!', 'error');
            }
        }

        // --- Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ---
        function exportDatabase() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state.db));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            const date = new Date();
            const fileName = `Ù†Ø³Ø®Ø©_ÙƒØ´Ø§ÙØ©_${date.getFullYear()}-${date.getMonth()+1}-${date.getDate()}_${date.getHours()}-${date.getMinutes()}.json`;
            downloadAnchorNode.setAttribute("download", fileName);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            showToast('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©');
        }

        function triggerImport() {
            document.getElementById('import-input').click();
        }

        function importDatabase(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if (json.cubs && json.scouts) {
                        if(confirm('Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù…Ù„Ù. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) {
                            state.db = json;
                            saveData(true);
                            alert("ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
                            render();
                            showToast('ØªÙ…Øª Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
                        }
                    } else {
                        alert("Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ´ÙÙŠØ© ØµØ§Ù„Ø­Ø©.");
                    }
                } catch(err) {
                    alert("Ù…Ù„Ù ØªØ§Ù„Ù Ø£Ùˆ ØºÙŠØ± ØµØ§Ù„Ø­.");
                }
            };
            reader.readAsText(file);
            input.value = '';
        }

        // --- Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (CRUD) ---
        function addItem(section, item) {
            const newItem = { ...item, id: Date.now(), createdAt: new Date().toLocaleDateString('ar-MA') };
            state.db[state.selectedStage][section].push(newItem);
            saveData(false); // ØªÙ… ØªØºÙŠÙŠØ±Ù‡Ø§ Ù„ØªØ¸Ù‡Ø± Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø­ÙØ¸
            render();
        }

        function deleteItem(section, id) {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ')) {
                state.db[state.selectedStage][section] = state.db[state.selectedStage][section].filter(i => i.id !== id);
                saveData(false);
                render();
                showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­', 'error');
            }
        }

        // --- Ø¯ÙˆØ§Ù„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (UI Actions) ---
        function setView(v) { state.view = v; state.errorMsg = ''; state.passwordInput = ''; render(); }
        function setLoginContext(c) { state.loginContext = c; setView('login'); }
        function handleStageSelect(id) { 
            state.selectedStage = id; 
            state.userRole === 'admin' ? setView('dashboard') : setView('unit-auth'); 
        }
        function handleScoutAccess() { state.userRole = 'scout'; setView('dashboard'); }
        function updatePassword(v) { state.passwordInput = v; }
        function setActiveTab(t) { state.activeTab = t; render(); }
        
        function handleLogout() {
            state.userRole = 'guest';
            state.selectedStage = null;
            setView('home');
        }

        function handleLoginSubmit() {
            const pwd = state.passwordInput;
            let success = false;
            
            if (state.loginContext === 'admin' && pwd === PASSWORDS.admin) {
                state.userRole = 'admin';
                setView('units');
                success = true;
            } else if (state.loginContext === 'leader' && pwd === PASSWORDS[state.selectedStage]) {
                state.userRole = 'leader';
                setView('dashboard');
                success = true;
            }

            if (!success) {
                state.errorMsg = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!';
                render();
            }
        }

        // --- Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (Components) ---
        function Header() {
            const logoutBtn = state.view !== 'home' 
                ? `<button onclick="handleLogout()" class="flex items-center gap-1 bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-sm transition text-white">
                     <i data-lucide="log-out" class="w-4 h-4"></i> Ø®Ø±ÙˆØ¬
                   </button>` 
                : '';
            
            return `
                <div class="w-full bg-emerald-900 text-white p-3 shadow-lg flex justify-between items-center" dir="rtl">
                    <div class="font-bold text-xl flex items-center gap-3">
                        <!-- Ø§Ù„Ø´Ø¹Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù‡Ù†Ø§ -->
                        <img src="https://i.pinimg.com/736x/66/18/be/6618be9986f6409c2de5efb034453dd4.jpg" 
                             class="w-10 h-10 rounded-lg object-cover border-2 border-white/30 shadow-md hover:scale-110 transition duration-300"
                             alt="Ø´Ø¹Ø§Ø± Ø§Ù„ÙƒØ´Ø§ÙØ©"
                             onerror="this.style.display='none'">
                             
                        <span class="tracking-wide">Ø§Ù„ÙƒØ´ÙÙŠØ© Ø§Ù„Ø­Ø³Ù†ÙŠØ© Ø§Ù„Ù…ØºØ±Ø¨ÙŠØ©</span>
                    </div>
                    ${logoutBtn}
                </div>
            `;
        }

        function HomeScreen() {
            return `
                <div class="relative flex flex-col items-center justify-center min-h-[85vh] p-4 animate-fadeIn overflow-hidden">
                    <!-- Ø®Ù„ÙÙŠØ© Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
                    <div class="absolute inset-0 z-0">
                        <img src="https://i.pinimg.com/1200x/64/a5/94/64a594dff8b10396e8df4d5c0091c408.jpg" class="w-full h-full object-cover opacity-20">
                    </div>

                    <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (ÙÙˆÙ‚ Ø§Ù„Ø®Ù„ÙÙŠØ©) -->
                    <div class="relative z-10 flex flex-col items-center w-full">
                        <div class="flex items-center justify-center gap-4 md:gap-10 mb-12"> 
                            
                            <!-- Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„ÙŠÙ…Ù†Ù‰ -->
                            <div class="flex flex-col items-center animate-bounce-slow">
                                <div class="w-24 h-24 md:w-32 md:h-32 bg-emerald-700 rounded-fu flex items-center justify-center shadow-xl border-4 border-green-700 overflow-hidden transform hover:scale-105 transition rounded-lg">
                                    <img src="https://i.pinimg.com/736x/66/18/be/6618be9986f6409c2de5efb034453dd4.jpg" class="w-full h-full object-cover opacity-100 ">
                                </div>
                            </div>
                            
                            <!-- Ø§Ù„Ø´Ø¹Ø§Ø± Ø§Ù„Ø£ÙˆØ³Ø·: ÙŠØ·ÙÙˆ Ù„ÙˆØ­Ø¯Ù‡ Ø¨Ø¯ÙˆÙ† Ø¥Ø·Ø§Ø± -->
                            <div class="flex flex-col items-center relative z-40 -mt-8 md:-mt-12"> 
                                <div class="w-35 h-35 md:w-56 md:h-56 flex items-center justify-center transform hover:scale-110 transition duration-500 filter drop-shadow border-4 border-green-700 rounded-lg ">
                                    <!-- Ø§Ù„ØµÙˆØ±Ø© Ù…Ù‚ØµÙˆØµØ© Ø¯Ø§Ø¦Ø±ÙŠØ§Ù‹ ÙˆÙ„ÙƒÙ† Ø¨Ø¯ÙˆÙ† Ø­Ø¯ÙˆØ¯ Ø®Ø§Ø±Ø¬ÙŠØ© -->
                                    <img src="https://i.pinimg.com/736x/b6/23/7f/b6237f449b7666f92c96fd59a994982c.jpg" class="w-full h-full object-cover rounded-2*1" >
                                </div>
                            </div>

                            <!-- Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„ÙŠØ³Ø±Ù‰ -->
                           <div class="flex flex-col items-center animate-bounce-slow">
                                <div class="w-24 h-24 md:w-32 md:h-32 bg-emerald-700 rounded- flex items-center justify-center shadow-xl border-4 border-green-700 overflow-hidden transform hover:scale-105 transition  rounded-lg">
                                    <img src="https://i.pinimg.com/736x/58/56/b6/5856b6659cffb1319a107d48fca3dc21.jpg" class="w-full h-full object-cover opacity-100">
                                </div>
                            </div>
                        </div>

                        <h1 class="text-4xl md:text-6xl font-extrabold text-emerald-900 mb-2 text-center drop-shadow-sm">ÙØ±Ø¹ Ù…Ø±Ø§ÙƒØ´ Ø§Ù„Ù…Ù†Ø§Ø±Ø©</h1>
                        <p class="text-gray-500 mb-12 text-lg">ÙƒÙ† Ù…Ø³ØªØ¹Ø¯Ø§Ù‹ .. Ø¯Ø§Ø¦Ù…Ø§Ù‹</p>

                        <div class="flex flex-col gap-4 w-full max-w-md">
                            <button onclick="setView('units')" class="bg-emerald-600 hover:bg-emerald-700 text-white text-xl font-bold py-4 rounded-xl shadow-lg transform hover:-translate-y-1 transition duration-300 flex items-center justify-center gap-3">
                                <i data-lucide="users"></i> Ù‚Ø§Ø¯Ø© Ø§Ù„Ù…Ø±Ø§Ø­Ù„ ÙˆØ§Ù„ÙˆØ­Ø¯Ø§Øª
                            </button>
                            
                            <button onclick="setLoginContext('admin')" class="bg-gray-800 hover:bg-gray-900 text-white text-lg font-bold py-3 rounded-xl shadow-md transform hover:-translate-y-1 transition duration-300 flex items-center justify-center gap-3">
                                <i data-lucide="shield" class="w-5 h-5"></i> Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function LoginScreen() {
            const title = state.loginContext === 'admin' ? "ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©" : `Ø¯Ø®ÙˆÙ„ Ù‚Ø§Ø¦Ø¯ ${STAGES[state.selectedStage]?.name}`;
            return `
                <div class="flex flex-col items-center justify-center min-h-[60vh] p-4 animate-fadeIn" dir="rtl">
                    <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md border-t-4 border-emerald-600">
                        <div class="flex justify-center mb-6 text-emerald-700"><i data-lucide="lock" class="w-12 h-12"></i></div>
                        <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">${title}</h2>
                        <input type="password" id="passwordInput" dir="ltr" value="${state.passwordInput}" oninput="updatePassword(this.value)" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ..." class="w-full p-3 border border-gray-300 rounded-lg mb-4 text-center text-lg focus:ring-2 focus:ring-emerald-500 outline-none placeholder:text-right" />
                        ${state.errorMsg ? `<p class="text-red-500 text-center mb-4 font-medium">${state.errorMsg}</p>` : ''}
                        <button onclick="handleLoginSubmit()" class="w-full bg-emerald-700 text-white py-3 rounded-lg font-bold hover:bg-emerald-800 transition shadow-md">Ø¯Ø®ÙˆÙ„</button>
                        <button onclick="setView('home')" class="w-full mt-3 text-gray-500 hover:text-gray-700">Ø¥Ù„ØºØ§Ø¡</button>
                    </div>
                </div>
            `;
        }

        function UnitsScreen() {
            const adminBadge = state.userRole === 'admin' ? '<span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm font-bold">ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¯ÙŠØ±</span>' : '';
            const backupControls = state.userRole === 'admin' ? `
                <div class="mb-8 p-6 bg-blue-50 border-2 border-blue-200 rounded-2xl flex flex-col md:flex-row justify-between items-center gap-6 shadow-sm">
                    <div class="flex items-start gap-3 text-blue-900">
                        <div class="bg-blue-100 p-2 rounded-lg"><i data-lucide="database" class="w-6 h-6 text-blue-600"></i></div>
                        <div>
                            <span class="font-bold text-lg block">Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø£Ù…Ø§Ù† (Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)</span>
                            <span class="text-sm text-blue-700 opacity-90">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙÙ‚Ø·: Ø­ÙØ¸ ÙˆØ§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒØ§Ù…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹</span>
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="exportDatabase()" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold transition">
                            <i data-lucide="download" class="w-4 h-4"></i> Ø­ÙØ¸ Ù†Ø³Ø®Ø©
                        </button>
                        <button onclick="triggerImport()" class="flex items-center gap-2 bg-white border border-blue-300 text-blue-700 hover:bg-blue-50 px-4 py-2 rounded-lg font-bold transition">
                            <i data-lucide="upload" class="w-4 h-4"></i> Ø§Ø³ØªØ±Ø¬Ø§Ø¹
                        </button>
                    </div>
                </div>
            ` : '';

            let cardsHtml = '';
            for (const key in STAGES) {
                const stage = STAGES[key];
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ®Ù„ÙÙŠØ© ÙƒØ§Ù…Ù„Ø© Ù„Ù„Ø¨Ø·Ø§Ù‚Ø© (object-cover) Ù„Ø¬Ù…Ø§Ù„ÙŠØ© Ø£ÙØ¶Ù„
                cardsHtml += `
                    <div onclick="handleStageSelect('${stage.id}')" class="bg-white rounded-2xl shadow-lg hover:shadow-2xl transition duration-300 cursor-pointer overflow-hidden transform hover:-translate-y-2 group border border-gray-100 relative">
                        <!-- Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø®Ù„ÙÙŠØ© -->
                        <div class="h-48 w-full overflow-hidden relative bg-white">
                            <!-- ØªÙ… Ø¥Ø±Ø¬Ø§Ø¹Ù‡Ø§ Ø¥Ù„Ù‰ object-cover Ù„ØªÙ…Ù„Ø£ Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø¨Ø´ÙƒÙ„ Ø¬Ù…ÙŠÙ„ -->
                            <img src="${stage.img}" alt="${stage.name}" class="w-full h-full object-cover transition duration-700 group-hover:scale-110" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                            
                            <!-- fallback if image fails -->
                            <div class="${stage.color} w-full h-full absolute top-0 left-0 hidden items-center justify-center">
                                <span class="text-6xl text-white">${stage.iconEmoji}</span>
                            </div>
                            
                            <!-- Overlay -->
                            <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent flex flex-col justify-end p-4 pointer-events-none">
                                <!-- Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø±Ø­Ù„Ø© (Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…ØµØºØ±Ø©) - object-cover Ù„Ù…Ù„Ø¡ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© -->
                                <div class="absolute top-4 right-4 bg-white p-1 rounded-full shadow-lg border-2 border-emerald-500">
                                    <img src="${stage.img}" class="w-10 h-10 rounded-full object-cover" onerror="this.src='https://via.placeholder.com/40'">
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-5 text-center relative z-10">
                            <h3 class="text-xl font-bold text-gray-800 mb-2 group-hover:text-emerald-600 transition">${stage.name}</h3>
                            <div class="flex items-center justify-center gap-1 text-emerald-600 text-sm font-medium opacity-80 group-hover:opacity-100">
                                <span>Ø§Ø¶ØºØ· Ù„Ù„Ø¯Ø®ÙˆÙ„</span>
                                <i data-lucide="arrow-left" class="w-4 h-4"></i>
                            </div>
                        </div>
                    </div>
                `;
            }
            return `
                <div class="max-w-6xl mx-auto p-6 animate-fadeIn min-h-[80vh]">
                    <div class="flex justify-between items-center mb-8">
                        <h2 class="text-3xl font-bold text-gray-800 border-r-4 border-emerald-500 pr-4">Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø§Ù„ÙƒØ´ÙÙŠØ©</h2>
                        ${adminBadge}
                    </div>
                    ${backupControls}
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                        ${cardsHtml}
                    </div>
                    <div class="mt-12 text-center">
                        <button onclick="setView('home')" class="text-gray-500 hover:text-emerald-700 font-medium flex items-center justify-center gap-2 mx-auto">
                            <i data-lucide="home" class="w-4 h-4"></i>
                            Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                        </button>
                    </div>
                </div>
            `;
        }

        function DashboardScreen() {
            const stage = STAGES[state.selectedStage];
            const data = state.db[state.selectedStage];
            const canEdit = state.userRole === 'admin' || state.userRole === 'leader';
            
            const backupSection = canEdit ? `
                <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-xl flex justify-between items-center flex-wrap gap-2">
                    <div class="text-blue-800 text-sm font-bold flex items-center gap-2">
                        <i data-lucide="save" class="w-4 h-4"></i>
                        <span>Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ (Ø£Ù…Ø§Ù†):</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="exportDatabase()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-lg text-sm font-bold flex items-center gap-1 transition shadow-sm">
                            <i data-lucide="download" class="w-4 h-4"></i> ØªØ­Ù…ÙŠÙ„ Ù†Ø³Ø®Ø©
                        </button>
                        <button onclick="triggerImport()" class="bg-white border border-blue-300 text-blue-700 hover:bg-blue-50 px-3 py-1.5 rounded-lg text-sm font-bold flex items-center gap-1 transition shadow-sm">
                            <i data-lucide="upload" class="w-4 h-4"></i> Ø§Ø³ØªØ±Ø¬Ø§Ø¹
                        </button>
                        <input type="file" id="import-input" class="hidden" accept=".json" onchange="importDatabase(this)" />
                    </div>
                </div>
            ` : '';

            const tabs = [
                { id: 'members', label: 'Ø§Ù„Ù…Ù†Ø®Ø±Ø·ÙˆÙ†', icon: 'users' },
                { id: 'attendance', label: 'Ù„Ø§Ø¦Ø­Ø© Ø§Ù„Ø­Ø¶ÙˆØ±', icon: 'check-square' },
                { id: 'projects', label: 'Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹', icon: 'compass' },
                { id: 'program', label: 'Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬', icon: 'calendar' }
            ];

            let tabsHtml = tabs.map(tab => `
                <button onclick="setActiveTab('${tab.id}')" 
                    class="flex-1 flex items-center justify-center gap-2 py-4 px-6 font-medium transition whitespace-nowrap ${state.activeTab === tab.id ? 'text-emerald-700 border-b-4 border-emerald-600 bg-emerald-50' : 'text-gray-500 hover:text-emerald-600 hover:bg-gray-50'}">
                    <i data-lucide="${tab.icon}" class="w-5 h-5"></i>
                    ${tab.label}
                </button>
            `).join('');

            let contentHtml = '';
            
            const renderTable = (headers, rows) => `
                <div class="overflow-x-auto">
                    <table class="w-full text-right border-collapse">
                        <thead><tr class="bg-gray-100 text-gray-700">${headers.map(h => `<th class="p-3">${h}</th>`).join('')}${canEdit ? '<th class="p-3 w-20">Ø¥Ø¬Ø±Ø§Ø¡</th>' : ''}</tr></thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>`;

            if (state.activeTab === 'members') {
                const rows = (data.members || []).map((m, idx) => `
                    <tr class="border-b border-gray-50 hover:bg-gray-50">
                        <td class="p-3 font-medium">${m.name}</td>
                        <td class="p-3 text-gray-600">${m.age ? m.age + ' Ø³Ù†Ø©' : '-'}</td>
                        <td class="p-3 text-gray-500">#${idx + 1}</td>
                        <td class="p-3 text-emerald-600 font-bold">${m.fee} Ø¯Ø±Ù‡Ù…</td>
                        ${canEdit ? `<td class="p-3 text-center"><button onclick="deleteItem('members', ${m.id})" class="text-red-500 hover:bg-red-50 p-2 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>` : ''}
                    </tr>`).join('');
                
                contentHtml = canEdit ? `
                    <form onsubmit="event.preventDefault(); const fd=new FormData(this); addItem('members', {name: fd.get('name'), age: fd.get('age'), fee: fd.get('fee')}); this.reset();" class="bg-gray-50 p-4 rounded-lg mb-6 border border-gray-200 shadow-sm grid gap-3 md:grid-cols-5 items-end">
                        <input name="name" required placeholder="Ø§Ù„Ø¥Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" class="p-2 border rounded md:col-span-2">
                        <input name="age" required type="number" placeholder="Ø§Ù„Ø³Ù†" class="p-2 border rounded">
                        <input name="fee" required type="number" placeholder="Ø«Ù…Ù† Ø§Ù„Ø§Ù†Ø®Ø±Ø§Ø·" class="p-2 border rounded">
                        <button type="submit" class="bg-emerald-600 text-white p-2 rounded hover:bg-emerald-700 flex items-center justify-center gap-1 font-bold"><i data-lucide="plus" class="w-4 h-4"></i> Ø¥Ø¶Ø§ÙØ©</button>
                    </form>` : '';
                contentHtml += rows ? renderTable(['Ø§Ù„Ø¥Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„', 'Ø§Ù„Ø³Ù†', 'Ø±Ù‚Ù… Ø§Ù„Ø§Ù†Ø®Ø±Ø§Ø·', 'Ø«Ù…Ù† Ø§Ù„Ø§Ù†Ø®Ø±Ø§Ø·'], rows) : '<p class="text-center p-8 text-gray-400">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>';
            
            } else if (state.activeTab === 'attendance') {
                const rows = (data.attendance || []).map(a => `
                     <tr class="border-b border-gray-50 hover:bg-gray-50">
                        <td class="p-3 font-medium">${a.name}</td>
                        <td class="p-3"><span class="px-3 py-1 rounded-full text-sm ${a.status === 'Ø­Ø§Ø¶Ø±' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">${a.status}</span></td>
                        ${canEdit ? `<td class="p-3 text-center"><button onclick="deleteItem('attendance', ${a.id})" class="text-red-500 hover:bg-red-50 p-2 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>` : ''}
                     </tr>`).join('');
                
                contentHtml = canEdit ? `
                     <form onsubmit="event.preventDefault(); const fd=new FormData(this); addItem('attendance', {name: fd.get('name'), status: fd.get('status')}); this.reset();" class="bg-gray-50 p-4 rounded-lg mb-6 border border-gray-200 shadow-sm grid gap-3 md:grid-cols-4 items-end">
                        <input name="name" required placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" class="p-2 border rounded md:col-span-2">
                        <select name="status" class="p-2 border rounded"><option value="Ø­Ø§Ø¶Ø±">Ø­Ø§Ø¶Ø±</option><option value="ØºØ§Ø¦Ø¨">ØºØ§Ø¦Ø¨</option></select>
                        <button type="submit" class="bg-emerald-600 text-white p-2 rounded hover:bg-emerald-700 flex items-center justify-center gap-1 font-bold"><i data-lucide="plus" class="w-4 h-4"></i> Ø¥Ø¶Ø§ÙØ©</button>
                    </form>` : '';
                contentHtml += rows ? renderTable(['Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„', 'Ø§Ù„Ø­Ø§Ù„Ø©'], rows) : '<p class="text-center p-8 text-gray-400">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>';

            } else if (state.activeTab === 'projects') {
                const cards = (data.projects || []).map(p => `
                    <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition bg-gradient-to-br from-white to-gray-50 relative group">
                        <h3 class="font-bold text-lg text-emerald-800 mb-2">${p.name}</h3>
                        <p class="text-gray-600 text-sm leading-relaxed">${p.desc}</p>
                        ${canEdit ? `<button onclick="deleteItem('projects', ${p.id})" class="absolute top-2 left-2 text-red-400 opacity-0 group-hover:opacity-100 hover:text-red-600 transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : ''}
                    </div>`).join('');
                
                contentHtml = canEdit ? `
                     <form onsubmit="event.preventDefault(); const fd=new FormData(this); addItem('projects', {name: fd.get('name'), desc: fd.get('desc')}); this.reset();" class="bg-gray-50 p-4 rounded-lg mb-6 border border-gray-200 shadow-sm grid gap-3 md:grid-cols-4 items-end">
                        <input name="name" required placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹" class="p-2 border rounded md:col-span-1">
                        <input name="desc" required placeholder="Ø§Ù„ÙˆØµÙ / Ø§Ù„Ø­Ø§Ù„Ø©" class="p-2 border rounded md:col-span-2">
                        <button type="submit" class="bg-emerald-600 text-white p-2 rounded hover:bg-emerald-700 flex items-center justify-center gap-1 font-bold"><i data-lucide="plus" class="w-4 h-4"></i> Ø¥Ø¶Ø§ÙØ©</button>
                    </form>` : '';
                contentHtml += `<div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">${cards}</div>`;

            } else if (state.activeTab === 'program') {
                const items = (data.program || []).map(prog => `
                    <div class="flex flex-col md:flex-row md:items-center bg-white border border-gray-100 p-4 rounded-lg shadow-sm hover:shadow-md transition">
                        <div class="flex items-center gap-3 md:w-1/4 mb-2 md:mb-0">
                            <div class="bg-emerald-100 text-emerald-700 p-2 rounded-lg"><i data-lucide="calendar" class="w-5 h-5"></i></div>
                            <span class="font-bold text-gray-700">${prog.date}</span>
                        </div>
                        <div class="md:w-2/4 mb-2 md:mb-0"><h4 class="font-bold text-lg text-gray-800">${prog.activity}</h4></div>
                        <div class="md:w-1/4 text-sm text-gray-500 flex justify-between items-center">
                            <span>${prog.notes}</span>
                            ${canEdit ? `<button onclick="deleteItem('program', ${prog.id})" class="text-red-400 hover:text-red-600 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : ''}
                        </div>
                    </div>`).join('');
                
                contentHtml = canEdit ? `
                     <form onsubmit="event.preventDefault(); const fd=new FormData(this); addItem('program', {activity: fd.get('activity'), date: fd.get('date'), notes: fd.get('notes')}); this.reset();" class="bg-gray-50 p-4 rounded-lg mb-6 border border-gray-200 shadow-sm grid gap-3 md:grid-cols-4 items-end">
                        <input name="activity" required placeholder="Ø§Ù„Ù†Ø´Ø§Ø·" class="p-2 border rounded">
                        <input name="date" required type="date" class="p-2 border rounded">
                        <input name="notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª" class="p-2 border rounded">
                        <button type="submit" class="bg-emerald-600 text-white p-2 rounded hover:bg-emerald-700 flex items-center justify-center gap-1 font-bold"><i data-lucide="plus" class="w-4 h-4"></i> Ø¥Ø¶Ø§ÙØ©</button>
                    </form>` : '';
                contentHtml += `<div class="space-y-3">${items}</div>`;
            }

            return `
                <div class="max-w-6xl mx-auto p-4 animate-fadeIn" dir="rtl">
                    <!-- ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‡ÙŠØ¯Ø± Ù„ÙŠØ´Ù…Ù„ ØµÙˆØ±Ø© Ø®Ù„ÙÙŠØ© -->
                    <div class="relative rounded-t-2xl overflow-hidden shadow-md text-white h-48">
                        <img src="${stage.img}" class="absolute w-full h-full object-cover">
                        <div class="absolute inset-0 bg-gradient-to-r from-black/80 to-transparent p-6 flex justify-between items-center">
                            <div class="relative z-10">
                                <h1 class="text-3xl font-bold flex items-center gap-3">
                                    <!-- ØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø¨Ø§Ù„Ø´Ø¹Ø§Ø± -->
                                    <img src="${stage.img}" class="w-16 h-16 rounded-full border-4 border-white/30 shadow-sm object-cover bg-white" onerror="this.src='https://via.placeholder.com/64'">
                                    ${stage.name}
                                </h1>
                                <p class="opacity-90 mt-1 mr-20 text-sm font-medium text-emerald-100">${state.userRole === 'admin' ? 'ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…' : state.userRole === 'leader' ? 'ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù‚Ø§Ø¦Ø¯' : 'ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©'}</p>
                            </div>
                            <button onclick="setView('units')" class="bg-white/20 hover:bg-white/30 p-2 rounded-full transition backdrop-blur-sm relative z-10"><i data-lucide="chevron-left" class="w-6 h-6"></i></button>
                        </div>
                    </div>

                    ${backupSection}

                    <div class="flex overflow-x-auto bg-white shadow border-b border-gray-200">
                        ${tabsHtml}
                    </div>
                    <div class="bg-white p-6 rounded-b-2xl shadow min-h-[400px]">
                        ${contentHtml}
                    </div>
                </div>
            `;
        }

        function render() {
            const app = document.getElementById('app');
            let html = Header();
            if (state.view === 'home') html += HomeScreen();
            else if (state.view === 'login') html += LoginScreen();
            else if (state.view === 'units') html += UnitsScreen();
            else if (state.view === 'unit-auth') html += UnitAuthScreen();
            else if (state.view === 'dashboard') html += DashboardScreen();
            app.innerHTML = html;
            if (window.lucide) lucide.createIcons();
            if (state.view === 'login') {
                const input = document.getElementById('passwordInput');
                if(input) {
                    input.focus();
                    input.value = state.passwordInput;
                }
            }
        }

        window.onload = function() {
            loadData();
        };
    </script>
    
</body>
</html>
